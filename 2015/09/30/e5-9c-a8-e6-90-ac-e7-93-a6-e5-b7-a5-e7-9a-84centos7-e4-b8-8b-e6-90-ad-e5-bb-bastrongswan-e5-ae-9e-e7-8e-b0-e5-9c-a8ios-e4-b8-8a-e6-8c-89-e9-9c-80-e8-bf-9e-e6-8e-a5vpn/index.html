<!DOCTYPE html>
<html lang="zh-CN" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<head>
  <meta charset="utf-8">
  <title>在搬瓦工的CentOS7下搭建Strongswan实现在iOS上按需连接VPN</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content="记录,在搬瓦工的CentOS7下搭建Strongswan实现在iOS上按需连接VPN">
  <meta name="description" content="查到的全是在Debian和Ubuntu下的教程，各种命令语法跟CentOS还有出入，Allen还是各种躲避。。。经历重新安装Debian后又重新装回CentOS的折腾后，终于搞定了。主要还是参考了iOS8 不越狱翻墙方案和iOS Ondemand IPSec VPN Setup，这两篇都是Debian和Ubuntu，只要稍作改动即可安装到CentOS上，简易教程来&#x1f426;。">
   

  <meta name="og:type" content="article">
  <meta name="og:site_name" content="Jamling's Blog and Project Site">
  <meta name="og:image" content="http://www.5cc.xyz/image/logo.png">
  <meta name="og:title" content="在搬瓦工的CentOS7下搭建Strongswan实现在iOS上按需连接VPN">
  <meta name="og:url" content="http://www.5cc.xyz/2015/09/30/e5-9c-a8-e6-90-ac-e7-93-a6-e5-b7-a5-e7-9a-84centos7-e4-b8-8b-e6-90-ad-e5-bb-bastrongswan-e5-ae-9e-e7-8e-b0-e5-9c-a8ios-e4-b8-8a-e6-8c-89-e9-9c-80-e8-bf-9e-e6-8e-a5vpn/">
  <meta name="og:description" content="查到的全是在Debian和Ubuntu下的教程，各种命令语法跟CentOS还有出入，Allen还是各种躲避。。。经历重新安装Debian后又重新装回CentOS的折腾后，终于搞定了。主要还是参考了iOS8 不越狱翻墙方案和iOS Ondemand IPSec VPN Setup，这两篇都是Debian和Ubuntu，只要稍作改动即可安装到CentOS上，简易教程来&#x1f426;。">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="Jamling's Blog and Project Site">
  <meta name="twitter:image" content="http://www.5cc.xyz/image/logo.png">
  <meta name="twitter:title" content="在搬瓦工的CentOS7下搭建Strongswan实现在iOS上按需连接VPN">
  <meta name="twitter:creator" content="@JamlingLi">
  <meta name="twitter:description" content="查到的全是在Debian和Ubuntu下的教程，各种命令语法跟CentOS还有出入，Allen还是各种躲避。。。经历重新安装Debian后又重新装回CentOS的折腾后，终于搞定了。主要还是参考了iOS8 不越狱翻墙方案和iOS Ondemand IPSec VPN Setup，这两篇都是Debian和Ubuntu，只要稍作改动即可安装到CentOS上，简易教程来&#x1f426;。">

  <!-- Canonical links -->
  <link rel="canonical" href="http://www.5cc.xyz/2015/09/30/e5-9c-a8-e6-90-ac-e7-93-a6-e5-b7-a5-e7-9a-84centos7-e4-b8-8b-e6-90-ad-e5-bb-bastrongswan-e5-ae-9e-e7-8e-b0-e5-9c-a8ios-e4-b8-8a-e6-8c-89-e9-9c-80-e8-bf-9e-e6-8e-a5vpn/index.html">
  <!-- Alternative links -->
  <!-- CSS and JS-->
  <script src="//cdn.bootcss.com/jquery/2.2.0/jquery.min.js"></script>
<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
<script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="//cdn.bootcss.com/sidr/2.2.1/jquery.sidr.min.js"></script>
<script src="/js/jquery.bootstrap-autohidingnavbar.min.js"></script>
<link rel="stylesheet" href="//cdn.bootcss.com/sidr/2.2.1/stylesheets/jquery.sidr.dark.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.6.0/styles/github.min.css">
<script src="//cdn.bootcss.com/highlight.js/9.6.0/highlight.min.js"></script>
<script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<link rel="stylesheet" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/fancybox/2.1.5/helpers/jquery.fancybox-buttons.css">
<script src="//cdn.bootcss.com/fancybox/2.1.5/helpers/jquery.fancybox-buttons.js"></script>
<script src="//cdn.bootcss.com/zclip/1.1.2/jquery.zclip.min.js"></script>
<link rel="stylesheet" href="/css/nova_font.css">
<link rel="stylesheet" href="/css/bs/nova.css">

  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="Tell YOU">
  <link rel="shortcut icon" href="/image/favicon.ico" type="image/x-icon" />
</head>
<body>
  <!-- header -->
  <header>
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top">
    <div class="container container-fluid">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse_" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" id="logo"><img src="/image/logo.png" height="50"></a>
      </div>
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
        <li><a href="/" class="main-nav">Home</a></li><li><a href="/p/" class="main-nav">Projects</a></li><li><a href="/categories/" class="main-nav">Category</a></li><li><a href="/archives/" class="main-nav">Archives</a></li><li><a href="/donate/" class="main-nav">Donate</a></li><li><a href="/about/" class="main-nav">About</a></li>
        </ul>
        <!-- search input -->
        

<!-- 百度站内搜索（已通过站点验证） -->
<form class="navbar-form navbar-left" role="search"
  action="//search.ieclipse.cn/cse/search">
  <div class="form-group search">
    <input type="text" name="q" id="bdcsMain" class="form-control primary" aria-label="..." placeholder="Search">
    <input type="hidden" name="s" value="11812712506721118476">
    <input type="hidden" name="nsid" value="0">
    <!-- 
    <input name="tn" type="hidden" value="SE_zzsearchcode_shhzc78w">
    <input name="cl" type="hidden" value="3">
    <input name="ct" type="hidden" value="2097152">
    <input name="si" type="hidden" value="ieclipse.cn">
    <input name="ie" type="hidden" value="utf-8">
    -->
  </div>
</form>

        <ul class="nav navbar-nav navbar-right">
        </ul>
      </div>
    </div>

    <script>
        <!-- mobile -->
    	$('.navbar-toggle').sidr({
	      name: 'sidr-main',
	      source: '#bs-example-navbar-collapse-1'
	    });
    	$('body').click(function(){
    	  $.sidr('close', 'sidr-main');
    	});
    	
    	$(".navbar-fixed-top").autoHidingNavbar({
    	  // see next for specifications
    	});
    </script>
  </nav>
</header>

  <!-- main -->
  
<div class="container container-fluid">
<div class="row">
  <div class="col-sx-12 col-sm-8 col-md-9 col-lg-9">
    
    
    <article class="article post" itemscope="itemscope" itemtype="http://schema.org/Article">
  <header class="article-header">
    <div class="page-path"><span class="post-category"><span class="glyphicon glyphicon-folder-close" aria-hidden="true"></span>Path: <a class="category-item" href="/">Blog</a><a class="category-item" href="/categories/记录/">记录</a></span></div>
    <div class="divider"></div>
      <h1 class="article-title" itemprop="name">在搬瓦工的CentOS7下搭建Strongswan实现在iOS上按需连接VPN</h1>
    <div class="post-header clearfix">
      <span class="post-date"><span class="hidden-xs icon nova-calendar">Post at: </span>
      <time datetime="2015-09-30T06:59:49.000Z" itemprop="datePublished"><time datetime="2015-09-30T06:59:49.000Z">2015-09-30</time></time>
      </span>
      
      <span class="post-share">
        <a href="#share" class="icon nova-share"><span class="hidden-xs">Share</span><span class="jiathis_counter_style"></span></a>
        <a href="#comment" class="icon nova-bubbles"><span class="ds-thread-count" data-thread-key="06a11e8782fabbcfd740dc877a37073c"></span><!-- <span class="hidden-xs">Comment</span> --></a>
        <a href="#like" class="icon nova-heart2-full"><span class="count"></span><span class="hidden-xs">Like</span></a>
        <a href="#" class="icon nova-eye"><span class="count"></span><span class="hidden-xs">Views</span></a>
      </span>
    </div>
    <div class="divider"></div>
  </header>
  <div class="article-content" itemprop="articleBody" id="post-content">
    <p>查到的全是在Debian和Ubuntu下的教程，各种命令语法跟CentOS还有出入，Allen还是各种躲避。。。经历重新安装Debian后又重新装回CentOS的折腾后，终于搞定了。主要还是参考了<a href="http://songchenwen.github.io/tech/2014/10/13/cross-fire-wall-on-ios8/" target="_blank" rel="external">iOS8 不越狱翻墙方案</a>和<a href="https://medium.com/@cattyhouse/ios-ondemand-ipsec-vpn-setup-ebfb82b6f7a1" target="_blank" rel="external">iOS Ondemand IPSec VPN Setup</a>，这两篇都是Debian和Ubuntu，只要稍作改动即可安装到CentOS上，简易教程来&#x1f426;。</p>
<p>首先我们来编译Strongswan，因为直接用yum install 的不能用，不解中&#x1f616; 下载源码和依赖包</p>
<pre><code>wget [http://download.strongswan.org/strongswan-5.2.2.tar.bz2](http://download.strongswan.org/strongswan-5.2.2.tar.bz2)
tar xjvf strongswan-5.2.2.tar.bz2; cd strongswan-5.2.2
yum install make gcc gmp-devel
`&lt;/pre&gt;
搬瓦工是OpenVZ的所以用下面的命令来配置
&lt;pre&gt;`./configure --sysconfdir=/etc --disable-sql --disable-mysql --disable-ldap --enable-dhcp --enable-eap-identity --enable-eap-mschapv2 --enable-md4 --enable-xauth-eap --enable-eap-peap --enable-eap-md5 --enable-openssl --enable-shared --enable-unity --enable-eap-tls   --enable-eap-ttls --enable-eap-tnc --enable-eap-dynamic --enable-addrblock --enable-radattr --enable-nat-transport --enable-kernel-netlink --enable-kernel-libipsec
`&lt;/pre&gt;

## 开始编译

&lt;pre&gt;`make &amp;amp;&amp;amp; sudo make install
`&lt;/pre&gt;
完全没有错误出现✌️

## 生成证书

开始生成证书想要ssl证书的可以看文章里的链接，有列出哦 建立个临时目录来生成证书，然后复制到/etc/ipsec.d/里
&lt;pre&gt;`mkdir ~/ipsec_cert &amp;amp;&amp;amp; cd ~/ipsec_cert
`&lt;/pre&gt;

### 生成服务器证书

用的是[iOS8 不越狱翻墙方案](http://songchenwen.github.io/tech/2014/10/13/cross-fire-wall-on-ios8/)他创建的脚本。SERVER换成泥自己的域名或IP都行
&lt;pre&gt;`wget [https://gist.githubusercontent.com/songchenwen/14c1c663ea65d5d4a28b/raw/cef8d8bafe6168388b105f780c442412e6f8ede7/server_key.sh](https://gist.githubusercontent.com/songchenwen/14c1c663ea65d5d4a28b/raw/cef8d8bafe6168388b105f780c442412e6f8ede7/server_key.sh)
sh server_key.sh SERVER
`&lt;/pre&gt;

### 生成客户端证书

同样是他的脚本，这个脚本还会生成一个p12证书，这个证书需要导入到iOS里，USER换成你自己的用户名 EMAIL换成你自己的email。
&lt;pre&gt;`wget [https://gist.githubusercontent.com/songchenwen/14c1c663ea65d5d4a28b/raw/54843ae2e5e6d1159134cd9a90a08c31ff5a253d/client_key.sh](https://gist.githubusercontent.com/songchenwen/14c1c663ea65d5d4a28b/raw/54843ae2e5e6d1159134cd9a90a08c31ff5a253d/client_key.sh)
sh client_key.sh USER EMAIL
`&lt;/pre&gt;
执行完后把.p12证书和cacerts/strongswanCert.pem 下载到本地来备用

我是在～目录里生成的证书，所以在本地端命令如下：
&lt;pre&gt;`scp -P ssh端口 root@服务器ip:~/ipsec_cert/janner.p12 ~/
scp -P ssh端口 root@服务器ip:~/ipsec_cert/cacerts strongswanCert.pem ~/
`&lt;/pre&gt;

## 配置Strongswan

### 编辑 /etc/ipsec.conf

&lt;pre&gt;`sudo vi /etc/ipsec.conf
`&lt;/pre&gt;
&lt;pre&gt;`config setup
    # strictcrlpolicy=yes
    #  uniqueids = replace
    # charondebug=&quot;cfg 2, dmn 2, ike 2, net 0&quot; #要看Log时，取消注释本行

conn %default
    keyexchange=ikev1
    dpdaction=hold
    dpddelay=600s
    dpdtimeout=5s
    lifetime=24h
    ikelifetime=240h
    rekey=no
    left=emptyzone.github.io #这里换成你登录 VPN 用的域名或 IP，与生成证书时相同 
    leftsubnet=0.0.0.0/0
    leftcert=vpnHostCert.pem
    leftsendcert=always
    right=%any
    rightdns=8.8.8.8
    rightsourceip=10.0.0.0/8

conn CiscoIPSec
    rightauth=pubkey
    rightauth2=xauth
    auto=add
`&lt;/pre&gt;

### 编辑/etc/ipsec.secrets

&lt;pre&gt;`sudo vi /etc/ipsec.secrets
`&lt;/pre&gt;
&lt;pre&gt;`#验证用户所需的信息
#用户名 : EAP &quot;密码&quot;
: RSA vpnHostKey.pem
你的用户名 : EAP &quot;你的密码&quot;  
`&lt;/pre&gt;

## 配置防火墙

&gt; 如果你看过我上一篇blog，防火墙就简单配置下，用firewalld很简单 主要就是开放4500、500端口和esp协议

### 编辑/usr/lib/firewalld/services/ipsec.xml如下：

&lt;pre&gt;`&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&amp;gt;
&amp;lt;service&amp;gt;
  &amp;lt;short&amp;gt;IPsec&amp;lt;/short&amp;gt;
  &amp;lt;description&amp;gt;Internet Protocol Security (IPsec) incorporates security for network transmissions directly into the Internet Protocol (IP). IPsec provides methods for both encrypting data and authentication for the host or network it sends to. If you plan to use a vpnc server or FreeS/WAN, do not disable this option.&amp;lt;/description&amp;gt;
  &amp;lt;port protocol=&quot;ah&quot; port=&quot;&quot;/&amp;gt;
  &amp;lt;port protocol=&quot;esp&quot; port=&quot;&quot;/&amp;gt;
  &amp;lt;port protocol=&quot;udp&quot; port=&quot;500&quot;/&amp;gt;
  &amp;lt;port protocol=&quot;udp&quot; port=&quot;4500&quot;/&amp;gt;
&amp;lt;/service&amp;gt;
`&lt;/pre&gt;
然后依次输入如下命令就OK了✌️
&lt;pre&gt;`
firewall-cmd --permanent --add-service=ipsec
firewall-cmd --permanent --add-masquerade
firewall-cmd --reload
</code></pre><p>其他的就是配置分流路由器和开机启动啥的，我都没怎么配置，到此服务器端配置结束&#x1f604;</p>
<p>你可以把下载的两个证书用email发送到你的iOS上，安装后建立个VPN连接，选IPsec，使用证书，选择你的用户名的证书即可，登录下试试吧。成功后就可以按照我上文所引用的两篇文章来使用Apple Configurator来配置你的描述文件，通用用email发送到iOS上安装即可，断线切换网络都会自动连接，给力吧，可以暂时抛弃Anyconnect了吧，哇咔咔，高级配置如只有特定域名才会连VPN的也能设置，自己可以琢磨了&#x1f604;</p>

  </div>
  <footer class="article-footer">
    <time class="article-footer-updated" datetime="2016-09-15T14:57:53.000Z" itemprop="dateModified">
        Last updated:  <span class="">2016-09-15</span>
    </time>
    
  <!-- JiaThis Button BEGIN -->
  <div class="jiathis_style clearfix"><a id="share" href="#share"></a>
      <span class="jiathis_txt icon nova-share">Share：</span>
      <a class="jiathis_button_tsina">Weibo</a>
      <a class="jiathis_button_weixin">Wechat</a>
      <a class="jiathis_button_twitter">Twitter</a>
      <a class="jiathis_button_copy">Copy Link</a>
      <a class="jiathis_button_ishare">One Share</a>
      <a href="http://www.jiathis.com/share?uid=2064663" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">More</a>
<!--       <a class="jiathis_counter_style"></a> -->
  </div>
  <!-- JiaThis Button END -->
  <script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2064663" charset="utf-8" async="async"></script>

  </footer>
  <span itemprop="author publisher" itemscope="itemscope" itemtype="http://schema.org/Organization">
    <meta content="http://www.5cc.xyz" itemprop="url">
    <meta content="Jamling's Blog and Project Site" itemprop="name">
    <meta content="/image/logo.png" itemprop="logo">
  </span>
</article>
<div>
  <nav><ul class="pager"><li class="previous"><a href="/2015/09/30/debain7-e5-8d-87-e7-ba-a7-e5-86-85-e6-a0-b8/"><span aria-hidden="true">&larr;</span><span class="hidden-xs">debain7升级内核</span></a></li><li class="next"><a href="/2015/09/30/l2tpipsec-e4-b8-80-e9-94-ae-e5-ae-89-e8-a3-85-e8-84-9a-e6-9c-acopenvz-e8-99-9a-e6-8b-9f-e5-8c-96-e6-8a-80-e6-9c-af-e7-9a-84-vps/"><span aria-hidden="true">&rarr;</span><span class="hidden-xs">L2TP+IPSec一键安装脚本(OpenVZ 虚拟化技术的 VPS)</span></a></li></ul></nav>
  
<!-- Button trigger modal -->
<blockquote class="donate"><!--
  <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#DonateModal">
    Donate
  </button>-->
  <p>
  <a href="#" role="button" data-toggle="modal" data-target="#DonateModal"><img src="/image/donate_button.png">
  <span>Dear reader, if you feel this good, could you rewark me a `bread` as awark? Thank you very much~</span></a>
  </p>
</blockquote>
<!-- Modal -->
<div class="modal fade" id="DonateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Donate</h4>
      </div>
      <div class="modal-body"><!--
        <table>
        <thead>
          <th class="text-center">支付宝</th>
          <th class="text-center">微信支付</th>
        </thead>
        <tr>
          <td><img src="/image/donate_alipay.png" alt="使用支付宝扫码打赏" class="img-rounded donate" width="200" height="200"></td>
          <td><img src="/image/donate_wechat.png" alt="使用微信扫码打赏" class="img-rounded donate" width="200" height="200"></td>
        </tr>
        </table>-->
        <div class="container-fluid">
        <div class="row">
        <div class="col-md-6">
          <div class="text-center">
            <span style="display:block;">支付宝</span>
            <img src="/image/donate_alipay.png" alt="使用支付宝扫码打赏" class="donate" />
          </div>
        </div>
        <div class="col-md-6">
          <div class="text-center">
            <span style="display:block;">微信支付</span>
            <img src="/image/donate_wechat.png" alt="使用微信扫码打赏" class="donate" />
          </div>
        </div>
        </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
  <a name="comment"></a>

<!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="06a11e8782fabbcfd740dc877a37073c" data-title="在搬瓦工的CentOS7下搭建Strongswan实现在iOS上按需连接VPN" data-url="http://www.5cc.xyz/2015/09/30/e5-9c-a8-e6-90-ac-e7-93-a6-e5-b7-a5-e7-9a-84centos7-e4-b8-8b-e6-90-ad-e5-bb-bastrongswan-e5-ae-9e-e7-8e-b0-e5-9c-a8ios-e4-b8-8a-e6-8c-89-e9-9c-80-e8-bf-9e-e6-8e-a5vpn/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"ieclipse"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
<!-- 多说公共JS代码 end -->

</div>

    
  </div>
  <!-- aside -->
  <div class="col-sx-12 col-sm-4 col-md-3 col-lg-3">
    <aside>
    </aside>
  </div>
</div>
</div>
  <!-- footer -->
  <footer id="footer">
  <div class="divider"></div>
  <div>&nbsp;</div>
  <div class="inner text-center">
    <div id="footer-copyright">
      &copy; 2016 <a href="http://ieclipse.cn/" target="_blank">Any_冰</a> powered by <a href="http://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Jamling/hexo-theme-nova" target="_blank">Nova</a><br>
      Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>.
    </div>
    <div>
      <a href="http://www.miitbeian.gov.cn" target="_blank">苏ICP备15019510号</a>
    </div>
  </div>
</footer>

  <!-- fixed action bar -->
  
  <div class="fab" style="bottom: 45px; right: 24px;">
    <ul class="top-expand" id="top-expand">
      <li><a class="fab-item large red" href="#top"><i class="icon nova-top"></i></a></li>
      <li><a class="fab-item large yellow " href="http://www.jiathis.com/share?uid=2064663" target="_blank"><i class="icon nova-share"></i></a></li>
    </ul>
    <a class="fab-item large red " onclick="$('#top-expand').toggle();">
      <i class="icon nova-list-ul"></i>
    </a>
  </div>
  <!-- after footer, some 3rd script place here -->
    <script type="text/javascript">
    var hljs_labels = {
        left: "Code",
        right: ":",
        copy: "Copy to clipboard"
    }
    </script>
    <script src="/js/hljs.js"></script>
    <script src="/js/script.js"></script>
    
    <!-- 安装自动推送JS代码的网页，在页面被访问时，页面URL将立即被推送给百度 -->
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

    
    <!-- 新建的搜索框代码，建立使用你自己的代码替换-->
<script type="text/javascript">
(function(){document.write(unescape('%3Cdiv id="bdcs"%3E%3C/div%3E'));var bdcs = document.createElement('script');bdcs.type = 'text/javascript';bdcs.async = true;bdcs.src = 'http://znsv.baidu.com/customer_search/api/js?sid=11812712506721118476' + '&plate_url=' + encodeURIComponent(window.location.href) + '&t=' + Math.ceil(new Date()/3600000);var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(bdcs, s);})();
</script>
    
<!-- LeanClound官方Javascript SDK -->
<script src="https://cdn1.lncld.net/static/js/av-min-1.2.1.js"></script>
<script>
  AV.init({
    appId : 'rYUER9KxmGUXSpfEtu7wCFMo-gzGzoHsz',
    appKey : 'k7hzTkcS0blxgry4VT9rJjYj'
  });

  var lc_config = {
    pageId : '06a11e8782fabbcfd740dc877a37073c',
    url : 'http://www.5cc.xyz/2015/09/30/e5-9c-a8-e6-90-ac-e7-93-a6-e5-b7-a5-e7-9a-84centos7-e4-b8-8b-e6-90-ad-e5-bb-bastrongswan-e5-ae-9e-e7-8e-b0-e5-9c-a8ios-e4-b8-8a-e6-8c-89-e9-9c-80-e8-bf-9e-e6-8e-a5vpn/' || '2015/09/30/e5-9c-a8-e6-90-ac-e7-93-a6-e5-b7-a5-e7-9a-84centos7-e4-b8-8b-e6-90-ad-e5-bb-bastrongswan-e5-ae-9e-e7-8e-b0-e5-9c-a8ios-e4-b8-8a-e6-8c-89-e9-9c-80-e8-bf-9e-e6-8e-a5vpn/',
    title : '在搬瓦工的CentOS7下搭建Strongswan实现在iOS上按需连接VPN'
  };
  
  var lc_table = 'Counter' || 'Counter';

  (function() {
    var query = new AV.Query(lc_table);
    query.select(['-ACL']);
    query.equalTo('pageId', lc_config.pageId);
    query.first({
      success: function(results) {
        // results is an array of AV.Object.
        if (typeof results === 'undefined') {
          insert(results);
          return;
        }
        console.log(results._serverData);
        update(results);
        show(results);
      },
      error: function(error) {
        // error is an instance of AV.Error.
        console.log(error);
      }
    });

    function insert(data) {
      if (!data) {
        console.log('data is null new object');
        var M = AV.Object.extend(lc_table);
        data = new M();
        data.set('views', 1);
      }
      for ( var key in lc_config) {
        data.set(key, lc_config[key]);
      }
      data.save().then(function(data) {
        console.log('created objectId is ' + data.id);
      }, function(error) {
        console.log("create object failed");
        console.log(error);
      });
    }

    function update(data) {
      data.increment('views', 1);
      for ( var key in lc_config) {
        if (key !== 'pageId')
        data.set(key, lc_config[key]);
      }
      data.save().then(function(data) {
        console.log("update to " + data.get('views'));
      }, function(error) {
        console.log("update object failed");
        console.log(error);
      });
    }
    
    function show(data) {
      $(".post-share .nova-eye .count").html(data.get('views'));
    }
  })();
</script>

</body>
</html>