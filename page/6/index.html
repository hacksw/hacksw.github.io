<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Any_冰" />


    
    


<meta name="description" content="hello,every body!~">
<meta property="og:type" content="website">
<meta property="og:title" content="Tell YOU">
<meta property="og:url" content="https://www.5cc.xyz/page/6/index.html">
<meta property="og:site_name" content="Tell YOU">
<meta property="og:description" content="hello,every body!~">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tell YOU">
<meta name="twitter:description" content="hello,every body!~">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Tell YOU" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Tell YOU</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Any_冰</a></h1>
        </hgroup>

        
        <p class="header-subtitle">~！随手记录生活点点滴滴!~</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:test@fbicn.xyz" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/sock5/">sock5</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Any_冰</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Any_冰</a></h1>
            </hgroup>
            
            <p class="header-subtitle">~！随手记录生活点点滴滴!~</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:test@fbicn.xyz" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-linux-ss5sock5-e4-bb-a3-e7-90-86-e5-ae-89-e8-a3-85" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/10/01/linux-ss5sock5-e4-bb-a3-e7-90-86-e5-ae-89-e8-a3-85/" class="article-date">
      <time datetime="2015-10-01T14:54:39.000Z" itemprop="datePublished">2015-10-01</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/01/linux-ss5sock5-e4-bb-a3-e7-90-86-e5-ae-89-e8-a3-85/">linux ss5(sock5)代理安装</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>VPN大家耳熟能详，但是socks用到的人比较少，那什么是socks呢？请看第二段或者百度百科，socks分别有4和5两个版本，现在5为主流。工作中经常用VPN访问国外，但是同时国内的速度又慢了，让人很纠结，实际上这个时候可以考虑使用socks。指定某一个程序使用国外socks即可。这样国内国外速度同时有保证。</p>
<p>SOCKS是什么：防火墙安全会话转换协议 （Socks: Protocol for sessions traversal across firewall securely） SOCKS 协议提供一个框架，为在 TCP 和 UDP 域中的客户机/服务器应用程序能更方便安全地使用网络防火墙所提供的服务。这个协议从概念上来讲是介于应用层和传输层之间的 “中介层（shim-layer）”，因而不提供如传递 ICMP 信息之类的网络层网关服务。开始我们的socks之旅吧<br>[v_act]<a href="http://sourceforge.net/projects/ss5/下载最新源码" target="_blank" rel="external">http://sourceforge.net/projects/ss5/下载最新源码</a><br>apt-get install libpam0g-dev</p>
<p>apt-get install libldap2-dev</p>
<p>apt-get install libssl-dev</p>
<p>1、修改/etc/opt/ss5/ss5.conf<br>auth 0.0.0.0/0 - u<br>permit u 0.0.0.0/0 - 0.0.0.0/0 - - - - -</p>
<p>3、在/etc/sysconfig/ss5 中，取消注释。<br>SS5_OPTS=” -u root”</p>
<p>4、添加验证用户及密码，由于密码是明文的，注意控制权限。</p>
<h1 id="cat-etc-opt-ss5-ss5-passwd-一行一个用户-密码"><a href="#cat-etc-opt-ss5-ss5-passwd-一行一个用户-密码" class="headerlink" title="cat etc/opt/ss5/ss5.passwd #一行一个用户+密码"></a>cat etc/opt/ss5/ss5.passwd #一行一个用户+密码</h1><p>2、在/etc/rc.d/init.d/ss5 文件修改自定义端口，默认为1080<br>ss5 -t $SS5_OPTS -b 0.0.0.0:8087[/v_act]<br><strong>centos</strong></p>
<p><strong>1. 安装socks 5</strong><br>1.1 安装依赖开发库</p>
<p><div id="crayon-560d1c75676fc730189388" class="crayon-syntax crayon-theme-visual-assist crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"></div></p>
<p><div class="crayon-main"></div></p>
<p><table class="crayon-table"></table></p>
<p><tbody></tbody></p>
<p><tr class="crayon-row"></tr></p>
<p><td class="crayon-nums " data-settings="hide"></td></p>
<p><div class="crayon-nums-content"></div></p>
<p><div class="crayon-num" data-line="crayon-560d1c75676fc730189388-1">1</div><br></p>
<p><td class="crayon-code"></td></p>
<p><div class="crayon-pre"></div></p>
<p><div id="crayon-560d1c75676fc730189388-1" class="crayon-line"><span class="crayon-p"># yum install pam-devel openldap-devel openssl-devel</span></div><br><br><br><br><br><br><br>1.2 安装socks 5 <a href="http://7xn6ev.com1.z0.glb.clouddn.com//wp-content/uploads/2015/10/201510011455297.gz" target="_blank" rel="external">ss5-3.8.9-8.tar(改下后缀tar.gz)</a></p>
<p><div id="crayon-560d1c756770b915112398" class="crayon-syntax crayon-theme-visual-assist crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"></div></p>
<p><div class="crayon-main"></div></p>
<p><table class="crayon-table"></table></p>
<p><tbody></tbody></p>
<p><tr class="crayon-row"></tr></p>
<p><td class="crayon-nums " data-settings="hide"></td></p>
<p><div class="crayon-nums-content"></div></p>
<p><div class="crayon-num" data-line="crayon-560d1c756770b915112398-1">1</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c756770b915112398-2">2</div></p>
<p><div class="crayon-num" data-line="crayon-560d1c756770b915112398-3">3</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c756770b915112398-4">4</div></p>
<p><div class="crayon-num" data-line="crayon-560d1c756770b915112398-5">5</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c756770b915112398-6">6</div><br></p>
<p><td class="crayon-code"></td></p>
<p><div class="crayon-pre"></div></p>
<p><div id="crayon-560d1c756770b915112398-1" class="crayon-line"><span class="crayon-p"># wget <a href="http://downloads.sourceforge.net/project/ss5/ss5/3.8.9-8/ss5-3.8.9-8.tar.gz?r=&amp;ts=1396802581&amp;use_mirror=cznic" target="_blank" rel="external">http://downloads.sourceforge.net/project/ss5/ss5/3.8.9-8/ss5-3.8.9-8.tar.gz?r=&amp;ts=1396802581&amp;use_mirror=cznic</a></span></div></p>
<p><div id="crayon-560d1c756770b915112398-2" class="crayon-line crayon-striped-line"><span class="crayon-p"># tar -xzvf ss5-3.8.9-8.tar.gz</span></div></p>
<p><div id="crayon-560d1c756770b915112398-3" class="crayon-line"><span class="crayon-p"># cd ss5-3.8.9</span></div></p>
<p><div id="crayon-560d1c756770b915112398-4" class="crayon-line crayon-striped-line"><span class="crayon-p"># ./configure</span></div></p>
<p><div id="crayon-560d1c756770b915112398-5" class="crayon-line"><span class="crayon-p"># make</span></div></p>
<p><div id="crayon-560d1c756770b915112398-6" class="crayon-line crayon-striped-line"><span class="crayon-p"># make install</span></div><br><br><br><br><br><br><br><strong>2. socks 5配置</strong><br>2.1 修改配置文件</p>
<p><div id="crayon-560d1c756770f804786072" class="crayon-syntax crayon-theme-visual-assist crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"></div></p>
<p><div class="crayon-plain-wrap"></div></p>
<p><div class="crayon-main"></div></p>
<p><table class="crayon-table"></table></p>
<p><tbody></tbody></p>
<p><tr class="crayon-row"></tr></p>
<p><td class="crayon-nums " data-settings="hide"></td></p>
<p><div class="crayon-nums-content"></div></p>
<p><div class="crayon-num" data-line="crayon-560d1c756770f804786072-1">1</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c756770f804786072-2">2</div></p>
<p><div class="crayon-num" data-line="crayon-560d1c756770f804786072-3">3</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c756770f804786072-4">4</div></p>
<p><div class="crayon-num" data-line="crayon-560d1c756770f804786072-5">5</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c756770f804786072-6">6</div></p>
<p><div class="crayon-num" data-line="crayon-560d1c756770f804786072-7">7</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c756770f804786072-8">8</div><br></p>
<p><td class="crayon-code"></td></p>
<p><div class="crayon-pre"></div></p>
<p><div id="crayon-560d1c756770f804786072-1" class="crayon-line"><span class="crayon-p"># vim /etc/opt/ss5/ss5.conf</span></div></p>
<p><div id="crayon-560d1c756770f804786072-2" class="crayon-line crayon-striped-line"><span class="crayon-i">auth</span> <span class="crayon-cn">0.0.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">0</span> – <span class="crayon-o">-</span></div></p>
<p><div id="crayon-560d1c756770f804786072-3" class="crayon-line">改为</div></p>
<p><div id="crayon-560d1c756770f804786072-4" class="crayon-line crayon-striped-line"><span class="crayon-i">auth</span> <span class="crayon-cn">0.0.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">0</span> – <span class="crayon-i">u</span></div></p>
<p><div id="crayon-560d1c756770f804786072-5" class="crayon-line"></div></p>
<p><div id="crayon-560d1c756770f804786072-6" class="crayon-line crayon-striped-line"><span class="crayon-i">permit</span> – <span class="crayon-cn">0.0.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">0</span> – <span class="crayon-cn">0.0.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">0</span> – – – – <span class="crayon-o">-</span></div></p>
<p><div id="crayon-560d1c756770f804786072-7" class="crayon-line">改成为</div></p>
<p><div id="crayon-560d1c756770f804786072-8" class="crayon-line crayon-striped-line"><span class="crayon-i">permit</span> <span class="crayon-i">u</span> <span class="crayon-cn">0.0.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">0</span> – <span class="crayon-cn">0.0.0.0</span><span class="crayon-o">/</span><span class="crayon-cn">0</span> – – – – <span class="crayon-o">-</span></div><br><br><br><br><br><br><br><strong>3. 添加socket 5用户</strong></p>
<p><div id="crayon-560d1c7567713791533395" class="crayon-syntax crayon-theme-visual-assist crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"></div></p>
<p><div class="crayon-plain-wrap"></div></p>
<p><div class="crayon-main"></div></p>
<p><table class="crayon-table"></table></p>
<p><tbody></tbody></p>
<p><tr class="crayon-row"></tr></p>
<p><td class="crayon-nums " data-settings="hide"></td></p>
<p><div class="crayon-nums-content"></div></p>
<p><div class="crayon-num" data-line="crayon-560d1c7567713791533395-1">1</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c7567713791533395-2">2</div></p>
<p><div class="crayon-num" data-line="crayon-560d1c7567713791533395-3">3</div><br></p>
<p><td class="crayon-code"></td></p>
<p><div class="crayon-pre"></div></p>
<p><div id="crayon-560d1c7567713791533395-1" class="crayon-line"><span class="crayon-p"># cat /etc/opt/ss5/ss5.passwd</span></div></p>
<p><div id="crayon-560d1c7567713791533395-2" class="crayon-line crayon-striped-line"> <span class="crayon-p">##用户  密码</span></div></p>
<p><div id="crayon-560d1c7567713791533395-3" class="crayon-line"><span class="crayon-i">ttlsa</span> <span class="crayon-cn">123456</span></div><br><br><br><br><br><br><br><strong>4. 启动socket 5</strong></p>
<p><div id="crayon-560d1c7567717787798230" class="crayon-syntax crayon-theme-visual-assist crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"></div></p>
<p><div class="crayon-plain-wrap"></div></p>
<p><div class="crayon-main"></div></p>
<p><table class="crayon-table"></table></p>
<p><tbody></tbody></p>
<p><tr class="crayon-row"></tr></p>
<p><td class="crayon-nums " data-settings="hide"></td></p>
<p><div class="crayon-nums-content"></div></p>
<p><div class="crayon-num" data-line="crayon-560d1c7567717787798230-1">1</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c7567717787798230-2">2</div><br></p>
<p><td class="crayon-code"></td></p>
<p><div class="crayon-pre"></div></p>
<p><div id="crayon-560d1c7567717787798230-1" class="crayon-line"><span class="crayon-p"># sh /etc/rc.d/init.d/ss5 start</span></div></p>
<p><div id="crayon-560d1c7567717787798230-2" class="crayon-line crayon-striped-line"><span class="crayon-e">doneting </span><span class="crayon-v">ss5</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><br><br><br><br><br><br><br>默认情况ss5文件没有执行权限，如果觉得使用sh来启动麻烦，那么按如下方法：</p>
<p><div id="crayon-560d1c756771a713658796" class="crayon-syntax crayon-theme-visual-assist crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"></div></p>
<p><div class="crayon-plain-wrap"></div></p>
<p><div class="crayon-main"></div></p>
<p><table class="crayon-table"></table></p>
<p><tbody></tbody></p>
<p><tr class="crayon-row"></tr></p>
<p><td class="crayon-nums " data-settings="hide"></td></p>
<p><div class="crayon-nums-content"></div></p>
<p><div class="crayon-num" data-line="crayon-560d1c756771a713658796-1">1</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c756771a713658796-2">2</div></p>
<p><div class="crayon-num" data-line="crayon-560d1c756771a713658796-3">3</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c756771a713658796-4">4</div><br></p>
<p><td class="crayon-code"></td></p>
<p><div class="crayon-pre"></div></p>
<p><div id="crayon-560d1c756771a713658796-1" class="crayon-line"><span class="crayon-p"># chmod u+x /etc/rc.d/init.d/ss5</span></div></p>
<p><div id="crayon-560d1c756771a713658796-2" class="crayon-line crayon-striped-line"><span class="crayon-p"># chkconfig –add ss5 //可选</span></div></p>
<p><div id="crayon-560d1c756771a713658796-3" class="crayon-line"><span class="crayon-p"># chkconfig ss5 on //可选</span></div></p>
<p><div id="crayon-560d1c756771a713658796-4" class="crayon-line crayon-striped-line"><span class="crayon-p"># service ss5 start</span></div><br><br><br><br><br><br><br><strong>5. 查看是否启动</strong></p>
<p><div id="crayon-560d1c756771e398435270" class="crayon-syntax crayon-theme-visual-assist crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"></div></p>
<p><div class="crayon-plain-wrap"></div></p>
<p><div class="crayon-main"></div></p>
<p><table class="crayon-table"></table></p>
<p><tbody></tbody></p>
<p><tr class="crayon-row"></tr></p>
<p><td class="crayon-nums " data-settings="hide"></td></p>
<p><div class="crayon-nums-content"></div></p>
<p><div class="crayon-num" data-line="crayon-560d1c756771e398435270-1">1</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c756771e398435270-2">2</div><br></p>
<p><td class="crayon-code"></td></p>
<p><div class="crayon-pre"></div></p>
<p><div id="crayon-560d1c756771e398435270-1" class="crayon-line"><span class="crayon-p"># netstat -lntp  | grep ss5</span></div></p>
<p><div id="crayon-560d1c756771e398435270-2" class="crayon-line crayon-striped-line"><span class="crayon-i">tcp</span>        <span class="crayon-cn">0</span>      <span class="crayon-cn">0</span> <span class="crayon-cn">0.0.0.0</span><span class="crayon-o">:</span><span class="crayon-cn">1080</span>   <span class="crayon-cn">0.0.0.0</span><span class="crayon-o">:</span><span class="crayon-o">*</span>      <span class="crayon-i">LISTEN</span>      <span class="crayon-cn">14262</span><span class="crayon-o">/</span><span class="crayon-v">ss5</span></div><br><br><br><br><br><br><br>默认端口1080</p>
<p><strong>6.</strong> 测试socks5<br>安装Proxifier，默认情况所有请求都走socks5.打开百度，输入IP，可以看到如下结果是我们运维生存时间（ttlsa.com）的ip地址</p>
<p><a href="http://www.ttlsa.com/wp-content/uploads/2014/04/socks5-test.jpg" target="_blank" rel="external"><img src="http://www.ttlsa.com/wp-content/uploads/2014/04/539x222xsocks5-test.jpg.pagespeed.ic.734JuaXs5L.webp" alt="Linux" title="linux下搭建socks 5代理"></a></p>
<p><strong>7. 常见错误</strong><br>7.1 缺少PAM</p>
<p><div id="crayon-560d1c7567723271870501" class="crayon-syntax crayon-theme-visual-assist crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover"></div></p>
<p><div class="crayon-plain-wrap"></div></p>
<p><div class="crayon-main"></div></p>
<p><table class="crayon-table"></table></p>
<p><tbody></tbody></p>
<p><tr class="crayon-row"></tr></p>
<p><td class="crayon-nums " data-settings="hide"></td></p>
<p><div class="crayon-nums-content"></div></p>
<p><div class="crayon-num" data-line="crayon-560d1c7567723271870501-1">1</div></p>
<p><div class="crayon-num crayon-striped-num" data-line="crayon-560d1c7567723271870501-2">2</div><br></p>
<p><td class="crayon-code"></td></p>
<p><div class="crayon-pre"></div></p>
<p><div id="crayon-560d1c7567723271870501-1" class="crayon-line"><span class="crayon-v">configure</span><span class="crayon-o">:</span> <span class="crayon-v">error</span><span class="crayon-o">:</span> <span class="crayon-o"><em></em></span><span class="crayon-o"></span><span class="crayon-o"><em></em></span> <span class="crayon-e">Some </span><span class="crayon-e">of </span><span class="crayon-e">the </span><span class="crayon-e">headers </span><span class="crayon-i">weren</span>‘<span class="crayon-i">t</span> <span class="crayon-e ">found </span><span class="crayon-o"><em></em></span><span class="crayon-o"></span></div></p>
<p><div id="crayon-560d1c7567723271870501-2" class="crayon-line crayon-striped-line"><span class="crayon-p"># yum -y install pam-devel</span></div><br><br><br><br><br><br><br>配置</p>
<p>一般来说安装完后，会在/etc目录下生成socks5.conf(配置文件)和socks5.passwd(用于验证的文件)这两个文件，<br>下面我把我的配置文件帖出来</p>
<p>#/etc/socks5.conf</p>
<p>#指定SOCKS v5绑定的ip地址和监听的端口。如果不指定绑定的IP将使用0.0.0.0<br>set SOCKS5_BINDINFC 192.168.0.8:1080</p>
<p>#忽略ident请求。当客户机没有运行identd时，使用SOCKS5_NOIDENT将降低超时值<br>set SOCKS5_NOIDENT</p>
<p>#指定连接停顿最长时间。超过最大值后，socks5断开连接<br>set SOCKS5_TIMEOUT 15</p>
<p>#socks5将接受SOCKS V4 协议的请求,默认不接受<br>set SOCKS5_V4SUPPORT</p>
<p>#指定同时存在的最大子进程数,Socks5预设为64<br>set SOCKS5_MAXCHILD 4</p>
<p>#指定密码文件<br>set SOCKS5_PWDFILE /usr/local/socks5/etc/socks5.passwd</p>
<p>#对所有的客户连接都使用username/password用户认证方法<br>auth - - u</p>
<p>#允许来自192.168.0.的任何经过用户认证的连接<br>permit u - 192.168.0. - - -</p>
<p><pre>#/usr/local/socks5/etc/socks5.passwd</pre></p>
<p>#用户  密码<br>userA passwdA<br>userB passwdB<br>userC passwdC<br>前面的一些设置由于我在配置文件里都写了相关的内容，就不在说明了<br>如果不需要用户验证只需要把<br> auth - - u<br>改成 auth - - -<br>permit u - 192.168.0. - - -<br>改成<br>permit - - - - - -<br><br>大家注意上面permit - - - - - -这一句，是使任何人都可以使用你的socks5 server，非常不安全（让你作跳板），最好是有点限制<br>如</p>
<p><pre>permit - - clientIP - - -</pre><br>开始测试</p>
<p><table border="1" width="100%" cellspacing="0" cellpadding="5" bgcolor="#cccccc"></table></p>
<p><tbody></tbody></p>
<p><tr></tr></p>
<td>

<pre><code>/usr/local/socks5/bin/socks5 -f -s`&lt;/pre&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
如果出现下面的信息表示测试成功。
&lt;table border=&quot;1&quot; width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;5&quot; bgcolor=&quot;#cccccc&quot;&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;pre&gt;`18210: Socks5 starting at Mon Dec 14 18:23:45 1998 in normal mode`&lt;/pre&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
然后退出socks5,开始正式运行它在背景模式：

正式运行
&lt;table border=&quot;1&quot; width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;5&quot; bgcolor=&quot;#cccccc&quot;&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;pre&gt;`/usr/local/socks5/bin/socks5 -t -s 2&amp;gt; /var/log/socks5`&lt;/pre&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
最后，加到/etc/rc.d/rc.local
&lt;table border=&quot;1&quot; width=&quot;601&quot; cellspacing=&quot;0&quot; cellpadding=&quot;5&quot; bgcolor=&quot;#cccccc&quot;&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;pre&gt;`
echo &quot;/usr/local/socks5/bin/socks5 -t -s 2&amp;gt; /var/log/socks5.log&quot;
&amp;gt;&amp;gt; /etc/rc.d/rc.local
</code></pre><p></p></td><br><br><br><br>如果要停止socks5，只要运行<span style="font-family: NSimsun;">/usr/local/socks5/bin/</span>stopsocks -kill就行，socks5就会停止！<br>启动测试：<span style="font-family: NSimsun;">/usr/local/socks5/bin/socks5 -t</span><br>使用非默认端口：如果你想让socks5服务启动的时候不启动默认监听端口1080，比如为1234，我们可以运行如下命令<br>socks5 -b 1234 -t 当然你关掉这个服务，就必须用下面的命令 <span style="font-family: NSimsun;">/usr/local/socks5/bin/</span>stopsocks -p 1234 -kill<p></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/记录/">记录</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-l2tpipsec-e9-85-8d-e7-bd-ae-e6-96-b9-e6-b3-95-e5-8c-85-e6-8b-ac-e4-b8-80-e9-94-ae-e8-84-9a-e6-9c-ac" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/10/01/l2tpipsec-e9-85-8d-e7-bd-ae-e6-96-b9-e6-b3-95-e5-8c-85-e6-8b-ac-e4-b8-80-e9-94-ae-e8-84-9a-e6-9c-ac/" class="article-date">
      <time datetime="2015-09-30T18:13:03.000Z" itemprop="datePublished">2015-10-01</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/01/l2tpipsec-e9-85-8d-e7-bd-ae-e6-96-b9-e6-b3-95-e5-8c-85-e6-8b-ac-e4-b8-80-e9-94-ae-e8-84-9a-e6-9c-ac/">L2TP+IPSec 配置方法 包括一键脚本</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="检测是否支持"><a href="#检测是否支持" class="headerlink" title="检测是否支持"></a>检测是否支持</h1><p>执行如下命令</p>
<ol>
<li><p><span class="pln">cat </span><span class="pun">/</span><span class="pln">dev</span><span class="pun">/</span><span class="pln">net</span><span class="pun">/</span><span class="pln">tun</span><br>返回信息应该为</p>
</li>
<li><p><span class="pln">cat</span><span class="pun">:</span> <span class="str">/dev/</span><span class="pln">net</span><span class="pun">/</span><span class="pln">tun</span><span class="pun">:</span> <span class="typ">File</span><span class="pln"> descriptor </span><span class="kwd">in</span><span class="pln"> bad state</span><br>再执行如下命令</p>
</li>
<li><p><span class="pln">cat </span><span class="pun">/</span><span class="pln">dev</span><span class="pun">/</span><span class="pln">ppp</span><br>返回信息应该为</p>
</li>
<li><p><span class="pln">cat</span><span class="pun">:</span> <span class="str">/dev/</span><span class="pln">ppp</span><span class="pun">:</span> <span class="typ">No</span><span class="pln"> such device </span><span class="kwd">or</span><span class="pln"> address</span><br>如果返回信息不同 那么请联系你的主机商开通TUN和PPP</p>
</li>
</ol>
<h1 id="CentOS手动编译"><a href="#CentOS手动编译" class="headerlink" title="CentOS手动编译"></a>CentOS手动编译</h1><h2 id="安装openswan"><a href="#安装openswan" class="headerlink" title="安装openswan"></a>安装openswan</h2><p>首先来安装openswan 如果之前装过 建议先删除 删除方法如下</p>
<ol>
<li><p><span class="pln">yum remove openswan</span><br>然后去openswan网站下载最新的源代码 在那之前先安装一些需要的依赖包</p>
</li>
<li><p><span class="pln">yum install make gcc gmp</span><span class="pun">-</span><span class="pln">devel bison flex</span><br>下载完openswan以后 解压缩openswan 进入openswan的目录 编译 安装</p>
</li>
<li><p><span class="pln">tar zxvf openswan</span><span class="pun">-</span><span class="pln">xxx</span><span class="pun">.</span><span class="pln">bz</span></p>
</li>
<li><span class="pln">cd openswan</span></li>
<li><span class="pln">make programs install</span></li>
</ol>
<h2 id="编辑ipsec-conf"><a href="#编辑ipsec-conf" class="headerlink" title="编辑ipsec.conf"></a>编辑ipsec.conf</h2><p>然后编辑 etc/ipsec.conf 这文件对格式要求很严格 缩进问题都会导致出错 所以这个下面的这个代码仅供参考 如果直接复制出现问题 请编辑原来的配置文件 修改成这样子</p>
<ol>
<li><span class="pln">version </span><span class="lit">2.0</span> <span class="com"># confirms to second version of ipsec.conf specification</span><br>2.3.  <span class="pln">config setup</span></li>
<li><span class="pln"> nat_traversal</span><span class="pun">=</span><span class="pln">yes</span></li>
<li><span class="pln"> virtual_private</span><span class="pun">=%</span><span class="pln">v4</span><span class="pun">:</span><span class="lit">10.0</span><span class="pun">.</span><span class="lit">0.0</span><span class="pun">/</span><span class="lit">8</span><span class="pun">,%</span><span class="pln">v4</span><span class="pun">:</span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">0.0</span><span class="pun">/</span><span class="lit">16</span><span class="pun">,%</span><span class="pln">v4</span><span class="pun">:</span><span class="lit">172.16</span><span class="pun">.</span><span class="lit">0.0</span><span class="pun">/</span><span class="lit">12</span><span class="pun">,%</span><span class="pln">v4</span><span class="pun">:</span><span class="lit">25.0</span><span class="pun">.</span><span class="lit">0.0</span><span class="pun">/</span><span class="lit">8</span><span class="pun">,%</span><span class="pln">v6</span><span class="pun">:</span><span class="pln">fd00</span><span class="pun">::</span><span class="str">/8,%v6:fe80::/</span><span class="lit">10</span></li>
<li><span class="pln"> oe</span><span class="pun">=</span><span class="pln">off</span></li>
<li><span class="pln"> protostack</span><span class="pun">=</span><span class="pln">netkey</span><br>8.9.  <span class="pln">conn L2TP</span><span class="pun">-</span><span class="pln">PSK</span><span class="pun">-</span><span class="pln">NAT</span></li>
<li><span class="pln"> rightsubnet</span><span class="pun">=</span><span class="pln">vhost</span><span class="pun">:%</span><span class="pln">priv</span></li>
<li><span class="pln"> also</span><span class="pun">=</span><span class="pln">L2TP</span><span class="pun">-</span><span class="pln">PSK</span><span class="pun">-</span><span class="pln">noNAT</span><br>12.13.  <span class="pln">conn L2TP</span><span class="pun">-</span><span class="pln">PSK</span><span class="pun">-</span><span class="pln">noNAT</span></li>
<li><span class="pln"> authby</span><span class="pun">=</span><span class="pln">secret</span></li>
<li><span class="pln"> pfs</span><span class="pun">=</span><span class="kwd">no</span></li>
<li><span class="kwd">auto</span><span class="pun">=</span><span class="pln">add</span></li>
<li><span class="pln"> keyingtries</span><span class="pun">=</span><span class="lit">3</span></li>
<li><span class="pln"> rekey</span><span class="pun">=</span><span class="kwd">no</span></li>
<li><span class="com"># Apple iOS doesn’t send delete notify so we need dead peer detection</span></li>
<li><span class="com"># to detect vanishing clients</span></li>
<li><span class="pln"> dpddelay</span><span class="pun">=</span><span class="lit">10</span></li>
<li><span class="pln"> dpdtimeout</span><span class="pun">=</span><span class="lit">10</span></li>
<li><span class="pln"> dpdaction</span><span class="pun">=</span><span class="pln">clear</span></li>
<li><span class="pln"> ikelifetime</span><span class="pun">=</span><span class="lit">8h</span></li>
<li><span class="pln"> keylife</span><span class="pun">=</span><span class="lit">1h</span></li>
<li><span class="pln"> type</span><span class="pun">=</span><span class="pln">transport</span></li>
<li><span class="pln"> left</span><span class="pun">=修改成你的服务器的</span><span class="pln">IP</span></li>
<li><span class="pln"> leftid</span><span class="pun">=修改成你的服务器的</span><span class="pln">IP</span></li>
<li><span class="pln"> leftprotoport</span><span class="pun">=</span><span class="lit">17</span><span class="pun">/</span><span class="lit">1701</span></li>
<li><span class="pln"> right</span><span class="pun">=%</span><span class="pln">any</span></li>
<li><span class="pln"> rightid</span><span class="pun">=%</span><span class="pln">any</span></li>
<li><span class="pln"> rightprotoport</span><span class="pun">=</span><span class="lit">17</span><span class="pun">/%</span><span class="pln">any</span></li>
</ol>
<h2 id="设置预共享密钥-PSK"><a href="#设置预共享密钥-PSK" class="headerlink" title="设置预共享密钥(PSK)"></a>设置预共享密钥(PSK)</h2><ol>
<li><p><span class="pln">vim </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">ipsec</span><span class="pun">.</span><span class="pln">secrets</span><br>上面的文件应该要自己建立，内容编辑成这样<br>SERVER-IP:服务器的IP地址<br>SharedKey:你自己设置的PSK</p>
</li>
<li><p><span class="pln">SERVER</span><span class="pun">-</span><span class="pln">IP </span><span class="pun">%</span><span class="pln">any</span><span class="pun">:</span><span class="pln"> PSK </span><span class="str">“SharedKey”</span><br>设置完毕以后ipsec就搞定了</p>
</li>
</ol>
<h2 id="安装依赖-PPP"><a href="#安装依赖-PPP" class="headerlink" title="安装依赖(PPP)"></a>安装依赖(PPP)</h2><ol>
<li><p><span class="pln">yum install libpcap</span><span class="pun">-</span><span class="pln">devel ppp</span></p>
</li>
<li><p><span class="pln">wget http</span><span class="pun">:</span><span class="com">//downloads.sourceforge.net/project/rp-l2tp/rp-l2tp/0.4/rp-l2tp-0.4.tar.gz</span></p>
</li>
<li><span class="pln">tar zxvf rp</span><span class="pun">-</span><span class="pln">l2tp</span><span class="pun">-</span><span class="lit">0.4</span><span class="pun">.</span><span class="pln">tar</span><span class="pun">.</span><span class="pln">gz</span></li>
<li><span class="pln">cd rp</span><span class="pun">-</span><span class="pln">l2tp</span><span class="pun">-</span><span class="lit">0.4</span></li>
<li><span class="pun">./</span><span class="pln">configure</span></li>
<li><span class="pln">make</span></li>
<li><span class="pln"> </span></li>
<li><span class="pln">cp handlers</span><span class="pun">/</span><span class="pln">l2tp</span><span class="pun">-</span><span class="pln">control </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">sbin</span><span class="pun">/</span></li>
<li><span class="pln">mkdir </span><span class="pun">/</span><span class="kwd">var</span><span class="pun">/</span><span class="pln">run</span><span class="pun">/</span><span class="pln">xl2tpd</span><span class="pun">/</span></li>
<li><span class="pln">ln </span><span class="pun">-</span><span class="pln">s </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">sbin</span><span class="pun">/</span><span class="pln">l2tp</span><span class="pun">-</span><span class="pln">control </span><span class="pun">/</span><span class="kwd">var</span><span class="pun">/</span><span class="pln">run</span><span class="pun">/</span><span class="pln">xl2tpd</span><span class="pun">/</span><span class="pln">l2tp</span><span class="pun">-</span><span class="pln">control</span></li>
<li><span class="pln"> </span></li>
<li><span class="pln">cd xl2tpd</span></li>
<li><span class="pln">make install</span></li>
<li><span class="pln"> </span></li>
<li><span class="pln">mkdir </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">xl2tpd</span></li>
<li><span class="pln">vim </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">xl2tpd</span><span class="pun">/</span><span class="pln">xl2tpd</span><span class="pun">.</span><span class="pln">conf</span><br>编辑成下面这个样子 设置以下你想分配给客户端的地址 以及虚拟服务器的IP</li>
</ol>
<p>1.2.  <span class="pun">[</span><span class="pln">lns </span><span class="kwd">default</span><span class="pun">]</span></p>
<ol>
<li><span class="pln">ip range </span><span class="pun">=</span> <span class="lit">192.168</span><span class="pun">.</span><span class="lit">1.128</span><span class="pun">-</span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">1.254</span></li>
<li><span class="kwd">local</span><span class="pln"> ip </span><span class="pun">=</span> <span class="lit">192.168</span><span class="pun">.</span><span class="lit">1.99</span></li>
<li><span class="kwd">require</span><span class="pln"> chap </span><span class="pun">=</span><span class="pln"> yes</span></li>
<li><span class="pln">refuse pap </span><span class="pun">=</span><span class="pln"> yes</span></li>
<li><span class="kwd">require</span><span class="pln"> authentication </span><span class="pun">=</span><span class="pln"> yes</span></li>
<li><span class="pln">name </span><span class="pun">=</span> <span class="typ">LinuxVPNserver</span></li>
<li><span class="pln">ppp debug </span><span class="pun">=</span><span class="pln"> yes</span></li>
<li><span class="pln">pppoptfile </span><span class="pun">=</span> <span class="str">/etc/</span><span class="pln">ppp</span><span class="pun">/</span><span class="pln">options</span><span class="pun">.</span><span class="pln">xl2tpd</span></li>
<li><span class="pln">length bit </span><span class="pun">=</span><span class="pln"> yes</span></li>
</ol>
<h2 id="修改xl2tp配置"><a href="#修改xl2tp配置" class="headerlink" title="修改xl2tp配置"></a>修改xl2tp配置</h2><ol>
<li><p><span class="pln">vim </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">ppp</span><span class="pun">/</span><span class="pln">options</span><span class="pun">.</span><span class="pln">xl2tpd</span><br>编辑成这样</p>
</li>
<li><p><span class="kwd">require</span><span class="pun">-</span><span class="pln">mschap</span><span class="pun">-</span><span class="pln">v2</span></p>
</li>
<li><span class="pln">ms</span><span class="pun">-</span><span class="pln">dns </span><span class="lit">8.8</span><span class="pun">.</span><span class="lit">8.8</span></li>
<li><span class="pln">ms</span><span class="pun">-</span><span class="pln">dns </span><span class="lit">8.8</span><span class="pun">.</span><span class="lit">4.4</span></li>
<li><span class="pln">asyncmap </span><span class="lit">0</span></li>
<li><span class="pln">auth</span></li>
<li><span class="pln">crtscts</span></li>
<li><span class="kwd">lock</span></li>
<li><span class="pln">hide</span><span class="pun">-</span><span class="pln">password</span></li>
<li><span class="pln">modem</span></li>
<li><span class="pln">debug</span></li>
<li><span class="pln">name l2tpd</span></li>
<li><span class="pln">proxyarp</span></li>
<li><span class="pln">lcp</span><span class="pun">-</span><span class="pln">echo</span><span class="pun">-</span><span class="pln">interval </span><span class="lit">30</span></li>
<li><span class="pln">lcp</span><span class="pun">-</span><span class="pln">echo</span><span class="pun">-</span><span class="pln">failure </span><span class="lit">4</span></li>
<li><span class="pln">mtu </span><span class="lit">1400</span></li>
<li><span class="pln">noccp</span></li>
<li><span class="pln">connect</span><span class="pun">-</span><span class="pln">delay </span><span class="lit">5000</span><br>上面的noccp用来解决IOS连接问题</li>
</ol>
<h2 id="添加账号密码"><a href="#添加账号密码" class="headerlink" title="添加账号密码"></a>添加账号密码</h2><ol>
<li><p><span class="pln">vim </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">ppp</span><span class="pun">/</span><span class="pln">chap</span><span class="pun">-</span><span class="pln">secrets</span><br>格式如下</p>
</li>
<li><p><span class="pun">账号</span><span class="pln"> l2tp </span><span class="pun">密码</span> <span class="pun"><em></em></span><br>账号密码用英文和数字 可以改为指定使用上面IP段中的IP地址</p>
</li>
</ol>
<h2 id="修改iptable规则"><a href="#修改iptable规则" class="headerlink" title="修改iptable规则"></a>修改iptable规则</h2><ol>
<li><p><span class="pln">iptables </span><span class="pun">-</span><span class="pln">I INPUT </span><span class="pun">-</span><span class="pln">p udp </span><span class="pun">-</span><span class="pln">m multiport </span><span class="pun">–</span><span class="pln">dport </span><span class="lit">1701</span><span class="pun">,</span><span class="lit">4500</span><span class="pun">,</span><span class="lit">500</span> <span class="pun">-</span><span class="pln">j ACCEPT</span><br>然后给客户端设置NAT伪装 (偷懒下 直接在接口上做伪装)</p>
</li>
<li><p><span class="pln">iptables </span><span class="pun">-</span><span class="pln">t nat </span><span class="pun">-</span><span class="pln">A POSTROUTING </span><span class="pun">-</span><span class="pln">o eth0 </span><span class="pun">-</span><span class="pln">j MASQUERADE</span></p>
</li>
</ol>
<h2 id="开启IP转发"><a href="#开启IP转发" class="headerlink" title="开启IP转发"></a>开启IP转发</h2><ol>
<li><p><span class="pln">vim </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">sysctl</span><span class="pun">.</span><span class="pln">conf</span><br>修改以下条目</p>
</li>
<li><p><span class="pln">net</span><span class="pun">.</span><span class="pln">ipv4</span><span class="pun">.</span><span class="pln">ip_forward </span><span class="pun">=</span> <span class="lit">1</span></p>
</li>
<li><span class="pln">net</span><span class="pun">.</span><span class="pln">ipv4</span><span class="pun">.</span><span class="pln">conf</span><span class="pun">.</span><span class="kwd">default</span><span class="pun">.</span><span class="pln">rp_filter </span><span class="pun">=</span> <span class="lit">0</span></li>
<li><p><span class="pln">net</span><span class="pun">.</span><span class="pln">ipv4</span><span class="pun">.</span><span class="pln">tcp_syncookies </span><span class="pun">=</span> <span class="lit">0</span><br>添加以下条目</p>
</li>
<li><p><span class="com"># Settings for OpenSwan IPSec implementation</span></p>
</li>
<li><span class="pln">net</span><span class="pun">.</span><span class="pln">ipv4</span><span class="pun">.</span><span class="pln">conf</span><span class="pun">.</span><span class="pln">all</span><span class="pun">.</span><span class="pln">send_redirects </span><span class="pun">=</span> <span class="lit">0</span></li>
<li><span class="pln">net</span><span class="pun">.</span><span class="pln">ipv4</span><span class="pun">.</span><span class="pln">conf</span><span class="pun">.</span><span class="kwd">default</span><span class="pun">.</span><span class="pln">send_redirects </span><span class="pun">=</span> <span class="lit">0</span></li>
<li><span class="pln">net</span><span class="pun">.</span><span class="pln">ipv4</span><span class="pun">.</span><span class="pln">conf</span><span class="pun">.</span><span class="pln">all</span><span class="pun">.</span><span class="pln">accept_redirects </span><span class="pun">=</span> <span class="lit">0</span></li>
<li><span class="pln">net</span><span class="pun">.</span><span class="pln">ipv4</span><span class="pun">.</span><span class="pln">conf</span><span class="pun">.</span><span class="kwd">default</span><span class="pun">.</span><span class="pln">accept_redirects </span><span class="pun">=</span> <span class="lit">0</span></li>
<li><p><span class="pln">net</span><span class="pun">.</span><span class="pln">core</span><span class="pun">.</span><span class="pln">xfrm_larval_drop </span><span class="pun">=</span> <span class="lit">1</span><br>运行一下命令让配置生效</p>
</li>
<li><p><span class="pln">sysctl </span><span class="pun">-</span><span class="pln">p</span></p>
</li>
</ol>
<h2 id="编辑xl2tp"><a href="#编辑xl2tp" class="headerlink" title="编辑xl2tp"></a>编辑xl2tp</h2><ol>
<li><p><span class="pln">vim </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">init</span><span class="pun">.</span><span class="pln">d</span><span class="pun">/</span><span class="pln">xl2tpd</span><br>编辑成这样</p>
</li>
<li><p><span class="com">#!/bin/sh</span><br>2.3.  <span class="com">#</span><br>4.5.  <span class="com"># xl2tpd This shell script takes care of starting and stopping l2tpd.</span><br>6.7.  <span class="com">#</span><br>8.9.  <span class="com"># chkconfig: - 80 30</span><br>10.11.  <span class="com"># description: Layer 2 Tunnelling Protocol Daemon (RFC 2661)</span><br>12.13.  <span class="com">#</span><br>14.15.  <span class="com"># processname: xl2tpd</span><br>16.17.  <span class="com"># config: /etc/xl2tpd/xl2tpd.conf</span><br>18.19.  <span class="com"># pidfile: /var/run/xl2tpd.pid</span><br>20.21.  <span class="com">#Servicename</span><br>22.23.  <span class="pln">SERVICE</span><span class="pun">=</span><span class="pln">xl2tpd</span><br>24.25.  <span class="com"># Source function library.</span><br>26.27.  <span class="pun">.</span> <span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">rc</span><span class="pun">.</span><span class="pln">d</span><span class="pun">/</span><span class="pln">init</span><span class="pun">.</span><span class="pln">d</span><span class="pun">/</span><span class="pln">functions</span><br>28.29.  <span class="com"># Source networking configuration.</span><br>30.31.  <span class="pun">.</span> <span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">sysconfig</span><span class="pun">/</span><span class="pln">network</span><br>32.33.  <span class="kwd">if</span> <span class="pun">[</span><span class="pln"> $</span><span class="pun">{</span><span class="pln">NETWORKING</span><span class="pun">}</span> <span class="pun">=</span> <span class="str">“no”</span> <span class="pun">]</span><br>34.35.  <span class="kwd">then</span><br>36.37.  <span class="kwd">exit</span> <span class="lit">0</span><br>38.39.  <span class="kwd">fi</span><br>40.41.  <span class="pun">[</span> <span class="pun">-</span><span class="pln">x </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">sbin</span><span class="pun">/</span><span class="pln">$SERVICE </span><span class="pun">]</span> <span class="pun">||</span> <span class="kwd">exit</span> <span class="lit">0</span><br>42.43.  <span class="pln">RETVAL</span><span class="pun">=</span><span class="lit">0</span><br>44.45.  <span class="pln">start</span><span class="pun">()</span> <span class="pun">{</span><br>46.47.  <span class="pln">echo </span><span class="pun">-</span><span class="pln">n </span><span class="str">“Starting $SERVICE: “</span><br>48.49.  <span class="kwd">if</span> <span class="pun">[</span> <span class="pun">!</span> <span class="pun">-</span><span class="pln">d </span><span class="pun">/</span><span class="kwd">var</span><span class="pun">/</span><span class="pln">run</span><span class="pun">/</span><span class="pln">xl2tpd </span><span class="pun">]</span><br>50.51.  <span class="kwd">then</span><br>52.53.  <span class="pln">mkdir </span><span class="pun">/</span><span class="kwd">var</span><span class="pun">/</span><span class="pln">run</span><span class="pun">/</span><span class="pln">xl2tpd</span><br>54.55.  <span class="kwd">fi</span><br>56.57.  <span class="pln">daemon </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">sbin</span><span class="pun">/</span><span class="pln">$SERVICE</span><br>58.59.  <span class="pln">RETVAL</span><span class="pun">=</span><span class="pln">$</span><span class="pun">?</span><br>60.61.  <span class="pun">[</span><span class="pln"> $RETVAL </span><span class="pun">-</span><span class="pln">eq </span><span class="lit">0</span> <span class="pun">]</span> <span class="pun">&amp;&amp;</span><span class="pln"> touch </span><span class="pun">/</span><span class="kwd">var</span><span class="pun">/</span><span class="kwd">lock</span><span class="pun">/</span><span class="pln">subsys</span><span class="pun">/</span><span class="pln">$SERVICE</span><br>62.63.  <span class="pln">echo </span><span class="str">“”</span><br>64.65.  <span class="kwd">return</span><span class="pln"> $RETVAL</span><br>66.67.  <span class="pun">}</span><br>68.69.  <span class="pln">stop</span><span class="pun">()</span> <span class="pun">{</span><br>70.71.  <span class="pln">echo </span><span class="pun">-</span><span class="pln">n </span><span class="str">“Stopping $SERVICE: “</span><br>72.73.  <span class="pln">killproc $SERVICE</span><br>74.75.  <span class="pln">RETVAL</span><span class="pun">=</span><span class="pln">$</span><span class="pun">?</span><br>76.77.  <span class="pln">echo</span><br>78.79.  <span class="pun">[</span><span class="pln"> $RETVAL </span><span class="pun">-</span><span class="pln">eq </span><span class="lit">0</span> <span class="pun">]</span> <span class="pun">&amp;&amp;</span><span class="pln"> rm </span><span class="pun">-</span><span class="pln">f </span><span class="pun">/</span><span class="kwd">var</span><span class="pun">/</span><span class="kwd">lock</span><span class="pun">/</span><span class="pln">subsys</span><span class="pun">/</span><span class="pln">$SERVICE</span><br>80.81.  <span class="kwd">return</span><span class="pln"> $RETVAL</span><br>82.83.  <span class="pun">}</span><br>84.85.  <span class="pln">restart</span><span class="pun">()</span> <span class="pun">{</span><br>86.87.  <span class="pln">stop</span><br>88.89.  <span class="pln">start</span><br>90.91.  <span class="pun">}</span><br>92.93.  <span class="com"># See how we were called.</span><br>94.95.  <span class="kwd">case</span> <span class="str">“$1”</span> <span class="kwd">in</span><br>96.97.  <span class="pln">start</span><span class="pun">)</span><br>98.99.  <span class="pln">start</span><br>100.101.  <span class="pun">;;</span><br>102.103.  <span class="pln">stop</span><span class="pun">)</span><br>104.105.  <span class="pln">stop</span><br>106.107.  <span class="pun">;;</span><br>108.109.  <span class="pln">status</span><span class="pun">)</span><br>110.111.  <span class="pln">status $SERVICE</span><br>112.113.  <span class="pln">RETVAL</span><span class="pun">=</span><span class="pln">$</span><span class="pun">?</span><br>114.115.  <span class="pun">;;</span><br>116.117.  <span class="pln">restart</span><span class="pun">|</span><span class="pln">reload</span><span class="pun">)</span><br>118.119.  <span class="pln">restart</span><br>120.121.  <span class="pun">;;</span><br>122.123.  <span class="pln">condrestart</span><span class="pun">)</span><br>124.125.  <span class="pun">[</span> <span class="pun">-</span><span class="pln">f </span><span class="pun">/</span><span class="kwd">var</span><span class="pun">/</span><span class="kwd">lock</span><span class="pun">/</span><span class="pln">subsys</span><span class="pun">/</span><span class="pln">$SERVICE </span><span class="pun">]</span> <span class="pun">&amp;&amp;</span><span class="pln"> restart </span><span class="pun">||</span> <span class="pun">:</span><br>126.127.  <span class="pun">;;</span><br>128.129.  <span class="pun">*)</span><br>130.131.  <span class="pln">echo </span><span class="str">“Usage: $SERVICE {start|stop|status|restart|reload|condrestart}”</span><br>132.133.  <span class="kwd">exit</span> <span class="lit">1</span><br>134.135.  <span class="kwd">esac</span><br>给它加上执行权限</p>
</li>
<li><p><span class="pln">chmod </span><span class="pun">+</span><span class="pln">x </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">init</span><span class="pun">.</span><span class="pln">d</span><span class="pun">/</span><span class="pln">xl2tpd</span><br>到这里就全部配置完成了 重启下几个服务</p>
</li>
<li><p><span class="pln">service iptables save</span></p>
</li>
<li><span class="pln">service iptables restart</span></li>
<li><span class="pln">service ipsec restart</span></li>
<li><span class="pln">service xl2tpd restart</span></li>
</ol>
<h2 id="xl2tp加入开机启动"><a href="#xl2tp加入开机启动" class="headerlink" title="xl2tp加入开机启动"></a>xl2tp加入开机启动</h2><ol>
<li><span class="pln">chkconfig </span><span class="pun">–</span><span class="pln">add xl2tpd</span><br><strong>下面是一键安装版本</strong></li>
</ol>
<h1 id="一键安装方法"><a href="#一键安装方法" class="headerlink" title="一键安装方法"></a>一键安装方法</h1><h2 id="下载脚本"><a href="#下载脚本" class="headerlink" title="下载脚本"></a>下载脚本</h2><p>CentOS Fedora或Redhat系统</p>
<ol>
<li><p><span class="pln">wget http</span><span class="pun">:</span><span class="com">//lamp.teddysun.com/files/l2tp.sh</span><br>Ubuntu系统</p>
</li>
<li><p><span class="pln">wget http</span><span class="pun">:</span><span class="com">//lamp.teddysun.com/files/l2tp_ubuntu.sh</span></p>
</li>
</ol>
<h2 id="赋予执行权限"><a href="#赋予执行权限" class="headerlink" title="赋予执行权限"></a>赋予执行权限</h2><ol>
<li><span class="pln">chmod </span><span class="pun">+</span><span class="pln">x </span><span class="pun">*.</span><span class="pln">sh</span></li>
</ol>
<h2 id="运行脚本"><a href="#运行脚本" class="headerlink" title="运行脚本"></a>运行脚本</h2><p>CentOS Fedora或Redhat系统</p>
<ol>
<li><p><span class="pun">./</span><span class="pln">l2tp</span><span class="pun">.</span><span class="pln">sh</span><br>Ubuntu系统</p>
</li>
<li><p><span class="pun">./</span><span class="pln">l2tp_ubuntu</span><span class="pun">.</span><span class="pln">sh</span><br>执行后会要求输入一些信息</p>
</li>
</ol>
<p>「Please input IP-Range:」表示输入IP段 默认为10.1.2 你可以输入10.0.0等自定义IP段</p>
<p>「Please input PSK:」表示输入PSK预共享密钥 自己输入一个即可 默认为vpn</p>
<p>确认无误后再次按回车开始安装 安装完成后会显示你的服务器IP 默认添加的账户密码和预共享密钥(PSK) 修改添加账户密码方法跟上面的一样</p>
<p>安装完如下图说明成功 可以使用了</p>
<p><a href="http://ww4.sinaimg.cn/large/81de4e80jw1eqbl8ejvu0j20gk06x75a.jpg" target="_blank" rel="external"><img src="http://ww4.sinaimg.cn/mw600/81de4e80jw1eqbl8ejvu0j20gk06x75a.jpg" alt="L2TP+IPSec 配置方法 包括一键脚本" title="L2TP+IPSec 配置方法 包括一键脚本"></a></p>
<h1 id="错误及解决方法"><a href="#错误及解决方法" class="headerlink" title="错误及解决方法"></a>错误及解决方法</h1><p>这里提供几个可能出现的错误及解决方法</p>
<h2 id="Pluto错误"><a href="#Pluto错误" class="headerlink" title="Pluto错误"></a>Pluto错误</h2><p>如果出现以下类似错误</p>
<ol>
<li><span class="typ">Checking</span><span class="pln"> that pluto </span><span class="kwd">is</span><span class="pln"> running </span><span class="pun">[</span><span class="pln">FAILED</span><span class="pun">]</span></li>
<li><span class="pln"> whack</span><span class="pun">:</span> <span class="typ">Pluto</span> <span class="kwd">is</span> <span class="kwd">not</span><span class="pln"> running </span><span class="pun">(</span><span class="kwd">no</span> <span class="str">“/var/run/pluto/pluto.ctl”</span><span class="pun">)</span><br>按照上面修改IPSec.conf的方法 把第一行的version 2.0加上去</li>
</ol>
<h2 id="iptable错误"><a href="#iptable错误" class="headerlink" title="iptable错误"></a>iptable错误</h2><ol>
<li><span class="pln">iptables</span><span class="pun">:</span> <span class="typ">Setting</span><span class="pln"> chains to policy ACCEPT</span><span class="pun">:</span><span class="pln"> security raw nat</span><span class="pun">[</span><span class="pln">FAILED</span><span class="pun">]</span><span class="pln">filter</span></li>
<li><span class="pln">iptables</span><span class="pun">:</span> <span class="typ">Flushing</span><span class="pln"> firewall rules</span><span class="pun">:</span> <span class="pun">[</span><span class="pln"> OK </span><span class="pun">]</span></li>
<li><span class="pln">iptables</span><span class="pun">:</span> <span class="typ">Unloading</span><span class="pln"> modules</span><span class="pun">:</span> <span class="pun">[</span><span class="pln"> OK </span><span class="pun">]</span></li>
<li><span class="pln">iptables</span><span class="pun">:</span> <span class="typ">Applying</span><span class="pln"> firewall rules</span><span class="pun">:</span> <span class="pun">[</span><span class="pln"> OK </span><span class="pun">]</span><br>这是Linode官方在iptables里加了一个security的规则链 但是centos不支持 解决方法如下</li>
</ol>
<p>修改iptables文件</p>
<ol>
<li><p><span class="pln">vim </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">init</span><span class="pun">.</span><span class="pln">d</span><span class="pun">/</span><span class="pln">iptables</span><br>找到如下case段 在raw后面加上security)段如下</p>
</li>
<li><p><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> $tables</span><span class="pun">;</span> <span class="kwd">do</span></p>
</li>
<li><span class="pln"> echo </span><span class="pun">-</span><span class="pln">n </span><span class="str">“$i “</span></li>
<li><span class="kwd">case</span> <span class="str">“$i”</span> <span class="kwd">in</span></li>
<li><span class="pln"> raw</span><span class="pun">)</span></li>
<li><span class="pln"> $IPTABLES </span><span class="pun">-</span><span class="pln">t raw </span><span class="pun">-</span><span class="pln">P PREROUTING $policy \</span></li>
<li><span class="pun">&amp;&amp;</span><span class="pln"> $IPTABLES </span><span class="pun">-</span><span class="pln">t raw </span><span class="pun">-</span><span class="pln">P OUTPUT $policy \</span></li>
<li><span class="pun">||</span> <span class="kwd">let</span><span class="pln"> ret</span><span class="pun">+=</span><span class="lit">1</span></li>
<li><span class="pun">;;</span></li>
<li><span class="pln"> security</span><span class="pun">)</span></li>
<li><span class="pln"> $IPTABLES </span><span class="pun">-</span><span class="pln">t filter </span><span class="pun">-</span><span class="pln">P INPUT $policy \</span></li>
<li><span class="pun">&amp;&amp;</span><span class="pln"> $IPTABLES </span><span class="pun">-</span><span class="pln">t filter </span><span class="pun">-</span><span class="pln">P OUTPUT $policy \</span></li>
<li><span class="pun">&amp;&amp;</span><span class="pln"> $IPTABLES </span><span class="pun">-</span><span class="pln">t filter </span><span class="pun">-</span><span class="pln">P FORWARD $policy \</span></li>
<li><span class="pun">||</span> <span class="kwd">let</span><span class="pln"> ret</span><span class="pun">+=</span><span class="lit">1</span></li>
<li><span class="pun">;;</span></li>
<li><span class="pln"> filter</span><span class="pun">)</span></li>
<li><span class="pln"> $IPTABLES </span><span class="pun">-</span><span class="pln">t filter </span><span class="pun">-</span><span class="pln">P INPUT $policy \</span></li>
<li><span class="pun">&amp;&amp;</span><span class="pln"> $IPTABLES </span><span class="pun">-</span><span class="pln">t filter </span><span class="pun">-</span><span class="pln">P OUTPUT $policy \</span></li>
<li><span class="pun">&amp;&amp;</span><span class="pln"> $IPTABLES </span><span class="pun">-</span><span class="pln">t filter </span><span class="pun">-</span><span class="pln">P FORWARD $policy \</span></li>
<li><span class="pun">||</span> <span class="kwd">let</span><span class="pln"> ret</span><span class="pun">+=</span><span class="lit">1</span></li>
<li><p><span class="pun">;;</span><br>运行如下命令重启iptables</p>
</li>
<li><p><span class="pln">service iptables restart</span><br>看到如下所示表示成功</p>
</li>
<li><p><span class="pln">iptables</span><span class="pun">:</span> <span class="typ">Setting</span><span class="pln"> chains to policy ACCEPT</span><span class="pun">:</span><span class="pln"> security raw nat</span><span class="pun">[</span><span class="pln"> OK </span><span class="pun">]</span><span class="pln">filter</span></p>
</li>
<li><span class="pln">iptables</span><span class="pun">:</span> <span class="typ">Flushing</span><span class="pln"> firewall rules</span><span class="pun">:</span> <span class="pun">[</span><span class="pln"> OK </span><span class="pun">]</span></li>
<li><span class="pln">iptables</span><span class="pun">:</span> <span class="typ">Unloading</span><span class="pln"> modules</span><span class="pun">:</span> <span class="pun">[</span><span class="pln"> OK </span><span class="pun">]</span></li>
<li><span class="pln">iptables</span><span class="pun">:</span> <span class="typ">Applying</span><span class="pln"> firewall rules</span><span class="pun">:</span> <span class="pun">[</span><span class="pln"> OK </span><span class="pun">]</span></li>
</ol>
<h1 id="客户端设置"><a href="#客户端设置" class="headerlink" title="客户端设置"></a>客户端设置</h1><p>配置好以后看看如何使用</p>
<p>这里以WIN7为例 其他系统可以自行参考设置</p>
<p>1、打开网络和共享中心 点击设置新的连接和网络</p>
<p><a href="http://ww2.sinaimg.cn/large/81de4e80jw1eqblm2hod5j20gb07ndhh.jpg" target="_blank" rel="external"><img src="http://ww2.sinaimg.cn/mw600/81de4e80jw1eqblm2hod5j20gb07ndhh.jpg" alt="L2TP+IPSec 配置方法 包括一键脚本" title="L2TP+IPSec 配置方法 包括一键脚本"></a></p>
<p>2、选择连接到工作区并点击下一步</p>
<p><a href="http://ww4.sinaimg.cn/large/81de4e80jw1eqblo9ejdqj20hg0duwgr.jpg" target="_blank" rel="external"><img src="http://ww4.sinaimg.cn/mw600/81de4e80jw1eqblo9ejdqj20hg0duwgr.jpg" alt="L2TP+IPSec 配置方法 包括一键脚本" title="L2TP+IPSec 配置方法 包括一键脚本"></a></p>
<p>3、点击创建新连接并下一步</p>
<p><a href="http://ww2.sinaimg.cn/large/81de4e80jw1eqblpd8ti7j20hg0du75t.jpg" target="_blank" rel="external"><img src="http://ww2.sinaimg.cn/mw600/81de4e80jw1eqblpd8ti7j20hg0du75t.jpg" alt="L2TP+IPSec 配置方法 包括一键脚本" title="L2TP+IPSec 配置方法 包括一键脚本"></a></p>
<p>4、选择使用我的Internet连接</p>
<p><a href="http://ww3.sinaimg.cn/large/81de4e80jw1eqblqoj0j0j20hg0dujtg.jpg" target="_blank" rel="external"><img src="http://ww3.sinaimg.cn/mw600/81de4e80jw1eqblqoj0j0j20hg0dujtg.jpg" alt="L2TP+IPSec 配置方法 包括一键脚本" title="L2TP+IPSec 配置方法 包括一键脚本"></a></p>
<p>5、Internet地址填入你的服务器IP地址 目标名称随意 用来自己识别 填完后点击下一步</p>
<p><a href="http://ww2.sinaimg.cn/large/81de4e80jw1eqblsj840kj20hg0duq4y.jpg" target="_blank" rel="external"><img src="http://ww2.sinaimg.cn/mw600/81de4e80jw1eqblsj840kj20hg0duq4y.jpg" alt="L2TP+IPSec 配置方法 包括一键脚本" title="L2TP+IPSec 配置方法 包括一键脚本"></a></p>
<p>6、填入你设置的用户名和密码 勾选记住此密码 如果你想每次连接都要求输入密码可以不勾选 并点击创建 然后关闭</p>
<p><a href="http://ww3.sinaimg.cn/large/81de4e80jw1eqblucj5v7j20hg0du3zs.jpg" target="_blank" rel="external"><img src="http://ww3.sinaimg.cn/mw600/81de4e80jw1eqblucj5v7j20hg0du3zs.jpg" alt="L2TP+IPSec 配置方法 包括一键脚本" title="L2TP+IPSec 配置方法 包括一键脚本"></a></p>
<p>7、右键点击你刚才创建的链接 点击属性</p>
<p><a href="http://ww4.sinaimg.cn/large/81de4e80jw1eqblwfzhnaj207o04t0t0.jpg" target="_blank" rel="external"><img src="http://ww4.sinaimg.cn/mw600/81de4e80jw1eqblwfzhnaj207o04t0t0.jpg" alt="L2TP+IPSec 配置方法 包括一键脚本" title="L2TP+IPSec 配置方法 包括一键脚本"></a></p>
<p>8、切换到安全选项卡设置VPN类型为IPSec</p>
<p><a href="http://ww2.sinaimg.cn/large/81de4e80jw1eqblybfhsgj20ah0cgq4g.jpg" target="_blank" rel="external"><img src="http://ww2.sinaimg.cn/mw600/81de4e80jw1eqblybfhsgj20ah0cgq4g.jpg" alt="L2TP+IPSec 配置方法 包括一键脚本" title="L2TP+IPSec 配置方法 包括一键脚本"></a></p>
<p>9、点击高级设置 选择使用预共享密钥作身份验证 并输入你刚才设置的预共享密钥(PSK) 一路确定设置完成 可以连接使用了</p>
<p><a href="http://ww1.sinaimg.cn/large/81de4e80jw1eqbm171ntgj20b907mwf8.jpg" target="_blank" rel="external"><img src="http://ww1.sinaimg.cn/mw600/81de4e80jw1eqbm171ntgj20b907mwf8.jpg" alt="L2TP+IPSec 配置方法 包括一键脚本" title="L2TP+IPSec 配置方法 包括一键脚本"></a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/随笔记录/">随笔记录</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-e4-bd-bf-e7-94-a8strongswan-e6-90-ad-e5-bb-baipsecikev2-vpn-2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/10/01/e4-bd-bf-e7-94-a8strongswan-e6-90-ad-e5-bb-baipsecikev2-vpn-2/" class="article-date">
      <time datetime="2015-09-30T17:49:19.000Z" itemprop="datePublished">2015-10-01</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/01/e4-bd-bf-e7-94-a8strongswan-e6-90-ad-e5-bb-baipsecikev2-vpn-2/">使用Strongswan搭建IPSec/IKEv2 VPN</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>本来Strongswan搭建IKEv2 VPN有一篇很好的教程（在nsshell.com上），但是貌似nsshell.com貌似挂了（反正我打不开），于是我就做个搬运，把教程拿过来。。正好原文中有一两处遗漏，我也好补上去。</p>
<p><strong>重要说明：本文原本只是给自己留一个参考，但似乎已经有很多人参考了这篇文章。一个月来我已经人工帮助了将近10个人无偿排查疑难问题。而作为一个学生，并没有多余的经历做这些事情。因此以后请不要找我问如何搭建VPN，谢谢。</strong></p>
<p>条件：<br>RAM大小合适的VPS或者服务器（96MB RAM就足够了，64MB RAM未测试）<br>可以是OpenVZ，但注意看教程中标注的针对OpenVZ的特殊步骤。</p>
<p>1.准备工作<br>请在虚拟机或服务器上安装好Ubuntu操作系统，32位、64位均可，建议14.04 LTS，并执行以下命令：</p>
<pre><code>apt-&lt;span class=&quot;hljs-keyword&quot;&gt;get&lt;/span&gt; update
apt-&lt;span class=&quot;hljs-keyword&quot;&gt;get&lt;/span&gt; install libpam0g-dev libssl-dev make gcc
`&lt;/pre&gt;
将PAM库和SSL库安装在系统中

2.下载最新的strongswan源代码并编译
&lt;pre class=&quot;  language-markup&quot;&gt;`&lt;span class=&quot;hljs-title&quot;&gt;wget&lt;/span&gt; [&lt;span class=&quot;hljs-url&quot;&gt;http://download.strongswan.org/strongswan.tar.gz&lt;/span&gt;](http://download.strongswan.org/strongswan.tar.gz)
tar xzf strongswan.tar.gz
cd strongswan-*
`&lt;/pre&gt;
OpenVZ使用以下参数
&lt;pre class=&quot;  language-markup&quot;&gt;`./configure  --enable-eap-identity --enable-eap-md5 \
--enable-eap-mschapv2 --enable-eap-tls --enable-eap-ttls --enable-eap-peap  \
--enable-eap-tnc --enable-eap-&lt;span class=&quot;hljs-keyword&quot;&gt;dynamic&lt;/span&gt; --enable-eap-radius --enable-xauth-eap  \
--enable-xauth-pam  --enable-dhcp  --enable-openssl  --enable-addrblock --enable-unity  \
--enable-certexpire --enable-radattr --enable-tools --enable-openssl --disable-gmp --enable-kernel-libipsec
`&lt;/pre&gt;
其它服务器执行
&lt;pre class=&quot;  language-markup&quot;&gt;`./configure  --enable-eap-identity --enable-eap-md5 \
--enable-eap-mschapv2 --enable-eap-tls --enable-eap-ttls --enable-eap-peap  \
--enable-eap-tnc --enable-eap-&lt;span class=&quot;hljs-keyword&quot;&gt;dynamic&lt;/span&gt; --enable-eap-radius --enable-xauth-eap  \
--enable-xauth-pam  --enable-dhcp  --enable-openssl  --enable-addrblock --enable-unity  \
--enable-certexpire --enable-radattr --enable-tools --enable-openssl --disable-gmp
`&lt;/pre&gt;
等待这个过程结束后，执行以下命令：
&lt;pre class=&quot;  language-markup&quot;&gt;`make; make install
`&lt;/pre&gt;
耐心地等待编译，性能不同编译所需时间也有所不同。

完成后使用命令`ipsec version`检查是否出现版本号等信息，如下图
![](https://hjc.im/content/images/2014/11/Capture.PNG)
若出现`ipsec: command not found`则代表没有成功编译安装。

3.配置strongswan和证书

生成CA证书
生成私钥
&lt;pre class=&quot;  language-markup&quot;&gt;`&lt;span class=&quot;hljs-title&quot;&gt;ipsec&lt;/span&gt; pki --gen --outform pem &amp;gt; ca.pem  
`&lt;/pre&gt;
利用私钥，签名CA证书
&lt;pre class=&quot;  language-markup&quot;&gt;`&lt;span class=&quot;hljs-title&quot;&gt;ipsec&lt;/span&gt; pki --self --in ca.pem --dn &lt;span class=&quot;hljs-string&quot;&gt;&quot;C=com, O=myvpn, CN=VPN CA&quot;&lt;/span&gt; --ca --outform pem &amp;gt;ca.cert.pem
`&lt;/pre&gt;
服务器证书 生成私钥
&lt;pre class=&quot;  language-markup&quot;&gt;`&lt;span class=&quot;hljs-title&quot;&gt;ipsec&lt;/span&gt; pki --gen --outform pem &amp;gt; server.pem
`&lt;/pre&gt;
用CA证书签发服务器证书

首先确认访问服务器的IP地址或域名，连接时**不可使用其它地址，只能使用证书中的地址，请将下面一句命令中的123.123.123.123替换为自己服务器的IP地址或域名，连接时使用**，一共需要替换**两处**。
&lt;pre class=&quot;  language-markup&quot;&gt;`&lt;span class=&quot;hljs-title&quot;&gt;ipsec&lt;/span&gt; pki --pub --in server.pem | ipsec pki --issue --cacert ca.cert.pem \
--cakey ca.pem --dn &lt;span class=&quot;hljs-string&quot;&gt;&quot;C=com, O=myvpn, CN=123.123.123.123&quot;&lt;/span&gt; \
--san=&lt;span class=&quot;hljs-string&quot;&gt;&quot;123.123.123.123&quot;&lt;/span&gt; --flag serverAuth --flag ikeIntermediate \
--outform pem &amp;gt; server.cert.pem
`&lt;/pre&gt;
客户端证书 生成私钥
&lt;pre class=&quot;  language-markup&quot;&gt;`&lt;span class=&quot;hljs-title&quot;&gt;ipsec&lt;/span&gt; pki --gen --outform pem &amp;gt; client.pem
`&lt;/pre&gt;
利用CA签名客户端证书
&lt;pre class=&quot;  language-markup&quot;&gt;`&lt;span class=&quot;hljs-title&quot;&gt;ipsec&lt;/span&gt; pki --pub --in client.pem | ipsec pki --issue --cacert ca.cert.pem --cakey ca.pem --dn &lt;span class=&quot;hljs-string&quot;&gt;&quot;C=com, O=myvpn, CN=VPN Client&quot;&lt;/span&gt; --outform pem &amp;gt; client.cert.pem
`&lt;/pre&gt;
生成pkcs12证书
&lt;pre class=&quot;  language-markup&quot;&gt;`openssl pkcs12 -&lt;span class=&quot;hljs-keyword&quot;&gt;export&lt;/span&gt; -inkey client.pem -&lt;span class=&quot;hljs-keyword&quot;&gt;in&lt;/span&gt; client.cert.pem -name &lt;span class=&quot;hljs-string&quot;&gt;&quot;client&quot;&lt;/span&gt; -certfile ca.cert.pem -caname &lt;span class=&quot;hljs-string&quot;&gt;&quot;VPN CA&quot;&lt;/span&gt;  -out client.cert.p12
`&lt;/pre&gt;
安装证书
&lt;pre class=&quot;  language-markup&quot;&gt;`cp -r ca.cert.pem /usr/&lt;span class=&quot;hljs-built_in&quot;&gt;local&lt;/span&gt;/etc/ipsec.d/cacerts/
cp -r server.cert.pem /usr/&lt;span class=&quot;hljs-built_in&quot;&gt;local&lt;/span&gt;/etc/ipsec.d/certs/
cp -r server.pem /usr/&lt;span class=&quot;hljs-built_in&quot;&gt;local&lt;/span&gt;/etc/ipsec.d/private/
cp -r client.cert.pem /usr/&lt;span class=&quot;hljs-built_in&quot;&gt;local&lt;/span&gt;/etc/ipsec.d/certs/
cp -r client.pem  /usr/&lt;span class=&quot;hljs-built_in&quot;&gt;local&lt;/span&gt;/etc/ipsec.d/private/
`&lt;/pre&gt;
证书安装完成，接下来配置strongswan，编辑`/usr/local/etc/ipsec.conf`
&lt;pre class=&quot;  language-markup&quot;&gt;`&lt;span class=&quot;hljs-title&quot;&gt;config&lt;/span&gt; setup
    uniqueids=never 

conn iOS_cert
    keyexchange=ikev1
    &lt;span class=&quot;hljs-comment&quot;&gt;# strongswan version &amp;gt;= 5.0.2, compatible with iOS 6.0,6.0.1&lt;/span&gt;
    fragmentation=&lt;span class=&quot;hljs-built_in&quot;&gt;yes&lt;/span&gt;
    left=%defaultroute
    leftauth=pubkey
    leftsubnet=&lt;span class=&quot;hljs-number&quot;&gt;0.0.0.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
    leftcert=server.cert.pem
    right=%any
    rightauth=pubkey
    rightauth2=xauth
    rightsourceip=&lt;span class=&quot;hljs-number&quot;&gt;10.31.2.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;
    rightcert=client.cert.pem
    auto=add

conn android_xauth_psk
    keyexchange=ikev1
    left=%defaultroute
    leftauth=psk
    leftsubnet=&lt;span class=&quot;hljs-number&quot;&gt;0.0.0.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
    right=%any
    rightauth=psk
    rightauth2=xauth
    rightsourceip=&lt;span class=&quot;hljs-number&quot;&gt;10.31.2.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;
    auto=add

conn networkmanager-strongswan
    keyexchange=ikev2
    left=%defaultroute
    leftauth=pubkey
    leftsubnet=&lt;span class=&quot;hljs-number&quot;&gt;0.0.0.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
    leftcert=server.cert.pem
    right=%any
    rightauth=pubkey
    rightsourceip=&lt;span class=&quot;hljs-number&quot;&gt;10.31.2.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;
    rightcert=client.cert.pem
    auto=add

conn windows7
    keyexchange=ikev2
    ike=aes256-sha1-modp1024! 
    rekey=&lt;span class=&quot;hljs-built_in&quot;&gt;no&lt;/span&gt;
    left=%defaultroute
    leftauth=pubkey
    leftsubnet=&lt;span class=&quot;hljs-number&quot;&gt;0.0.0.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;
    leftcert=server.cert.pem
    right=%any
    rightauth=eap-mschapv2
    rightsourceip=&lt;span class=&quot;hljs-number&quot;&gt;10.31.2.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;
    rightsendcert=never
    eap_identity=%any
    auto=add
`&lt;/pre&gt;
编辑`/usr/local/etc/strongswan.conf`
&lt;pre class=&quot;  language-markup&quot;&gt;` &lt;span class=&quot;hljs-title&quot;&gt;charon&lt;/span&gt; {
         &lt;span class=&quot;hljs-title&quot;&gt;load_modular&lt;/span&gt; = &lt;span class=&quot;hljs-built_in&quot;&gt;yes&lt;/span&gt;
         duplicheck.enable = &lt;span class=&quot;hljs-built_in&quot;&gt;no&lt;/span&gt;
         compress = &lt;span class=&quot;hljs-built_in&quot;&gt;yes&lt;/span&gt;
         plugins {
                 &lt;span class=&quot;hljs-title&quot;&gt;include&lt;/span&gt; strongswan.d/charon/&lt;span class=&quot;hljs-regexp&quot;&gt;*.conf&lt;/span&gt;
         }
         dns1 = &lt;span class=&quot;hljs-number&quot;&gt;8.8.8.8&lt;/span&gt;
         dns2 = &lt;span class=&quot;hljs-number&quot;&gt;8.8.4.4&lt;/span&gt;
         nbns1 = &lt;span class=&quot;hljs-number&quot;&gt;8.8.8.8&lt;/span&gt;
         nbns2 = &lt;span class=&quot;hljs-number&quot;&gt;8.8.4.4&lt;/span&gt;
 }
 include strongswan.d/&lt;span class=&quot;hljs-regexp&quot;&gt;*.conf&lt;/span&gt;
`&lt;/pre&gt;
编辑`/usr/local/etc/ipsec.secrets`中的用户名、密码
&lt;pre class=&quot;  language-markup&quot;&gt;`: RSA server.pem
: PSK &lt;span class=&quot;hljs-string&quot;&gt;&quot;mykey&quot;&lt;/span&gt;
: XAUTH &lt;span class=&quot;hljs-string&quot;&gt;&quot;mykey&quot;&lt;/span&gt;
[用户名] %any : EAP &lt;span class=&quot;hljs-string&quot;&gt;&quot;[密码]&quot;&lt;/span&gt;
`&lt;/pre&gt;
注意将PSK、XAUTH处的&quot;mykey&quot;编辑为**唯一且私密的字符串**，并且将[用户名]改为自己想要的登录名，[密码]改为自己想要的密码（[]符号去掉），可以添加多行，得到多个用户。

4.修改系统转发以及防火墙配置
首先编辑`/etc/sysctl.conf`，将`net.ipv4.ip_forward=1`一行前面的`#`号去掉，保存后执行`sysctl -p`。
接下来修改iptables。
OpenVZ执行：
&lt;pre class=&quot;  language-markup&quot;&gt;`&lt;span class=&quot;hljs-title&quot;&gt;iptables&lt;/span&gt; -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.0.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;  -j ACCEPT
iptables -A FORWARD -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.1.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;  -j ACCEPT
iptables -A FORWARD -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.2.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;  -j ACCEPT
iptables -A INPUT -i venet0 -p esp -j ACCEPT
iptables -A INPUT -i venet0 -p udp --dport &lt;span class=&quot;hljs-number&quot;&gt;500&lt;/span&gt; -j ACCEPT
iptables -A INPUT -i venet0 -p tcp --dport &lt;span class=&quot;hljs-number&quot;&gt;500&lt;/span&gt; -j ACCEPT
iptables -A INPUT -i venet0 -p udp --dport &lt;span class=&quot;hljs-number&quot;&gt;4500&lt;/span&gt; -j ACCEPT
iptables -A INPUT -i venet0 -p udp --dport &lt;span class=&quot;hljs-number&quot;&gt;1701&lt;/span&gt; -j ACCEPT
iptables -A INPUT -i venet0 -p tcp --dport &lt;span class=&quot;hljs-number&quot;&gt;1723&lt;/span&gt; -j ACCEPT
iptables -A FORWARD -j REJECT
iptables -t nat -A POSTROUTING -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.0.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt; -o venet0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.1.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt; -o venet0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.2.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt; -o venet0 -j MASQUERADE
`&lt;/pre&gt;
其它服务器执行
&lt;pre class=&quot;  language-markup&quot;&gt;`&lt;span class=&quot;hljs-title&quot;&gt;iptables&lt;/span&gt; -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.0.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;  -j ACCEPT
iptables -A FORWARD -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.1.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;  -j ACCEPT
iptables -A FORWARD -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.2.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt;  -j ACCEPT
iptables -A INPUT -i eth0 -p esp -j ACCEPT
iptables -A INPUT -i eth0 -p udp --dport &lt;span class=&quot;hljs-number&quot;&gt;500&lt;/span&gt; -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --dport &lt;span class=&quot;hljs-number&quot;&gt;500&lt;/span&gt; -j ACCEPT
iptables -A INPUT -i eth0 -p udp --dport &lt;span class=&quot;hljs-number&quot;&gt;4500&lt;/span&gt; -j ACCEPT
iptables -A INPUT -i eth0 -p udp --dport &lt;span class=&quot;hljs-number&quot;&gt;1701&lt;/span&gt; -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --dport &lt;span class=&quot;hljs-number&quot;&gt;1723&lt;/span&gt; -j ACCEPT
iptables -A FORWARD -j REJECT
iptables -t nat -A POSTROUTING -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.0.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt; -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.1.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt; -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s &lt;span class=&quot;hljs-number&quot;&gt;10.31.2.0&lt;/span&gt;/&lt;span class=&quot;hljs-number&quot;&gt;24&lt;/span&gt; -o eth0 -j MASQUERADE
`&lt;/pre&gt;
接下来（公共部分）保存iptables配置并配置开机自动载入
&lt;pre class=&quot;  language-markup&quot;&gt;`iptables-save &amp;gt; /etc/iptables.rules
cat &amp;gt; /etc/network/&lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt;-up.d/iptables&amp;lt;&amp;lt;EOF
&lt;span class=&quot;hljs-shebang&quot;&gt;#!/bin/sh&lt;/span&gt;
iptables-restore &amp;lt; /etc/iptables.rules
EOF
chmod +x /etc/network/&lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt;-up.d/iptables
</code></pre><p>5.尝试连接<br>WP8.1手机安装ca.cert.pem，进入设置-VPN添加IKEv2连接，地址为<strong>证书中的地址或IP</strong>，通过用户名-密码连接。<br>Windows连接也是一样，但注意<strong>将证书导入本地计算机而不是当前用户的“受信任的证书颁发机构”</strong>。<br>iOS/Android/Mac OS X设备添加Cisco IPSec PSK验证方式，预共享密钥是<code>/usr/local/etc/ipsec.secrets</code>中PSK后的字符串（不含引号），用户名密码同上，<strong>可以通过任意域名或IP连接，不需要证书</strong></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/便宜vps/">便宜vps</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-debain7-e5-8d-87-e7-ba-a7-e5-86-85-e6-a0-b8" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/09/30/debain7-e5-8d-87-e7-ba-a7-e5-86-85-e6-a0-b8/" class="article-date">
      <time datetime="2015-09-30T08:07:59.000Z" itemprop="datePublished">2015-09-30</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/09/30/debain7-e5-8d-87-e7-ba-a7-e5-86-85-e6-a0-b8/">debain7升级内核</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="现在升级-Linux-Kernel"><a href="#现在升级-Linux-Kernel" class="headerlink" title="现在升级 Linux Kernel"></a>现在升级 Linux Kernel</h3><p>要想升级你的内核，运行下列命令来升级所有安装包和现存内核。</p>
<ol>
<li><span class="kwd">sudo</span> <span class="kwd">apt-get</span><span class="pln"> update</span><br><span class="kwd">sudo</span> <span class="kwd">apt-get</span><span class="pln"> dist</span><span class="pun">-</span><span class="pln">upgrade</span><br><span class="kwd">sudo</span> <span class="kwd">apt-get</span><span class="pln"> autoremove</span><br>升级完成后，重启你的设备。在安装完系统包和内核后重启机器是一个好习惯。这样做是为了让新的内核能够被应用。</li>
</ol>
<p>接下来，运行下列命令来下载 Linux Kernel 3.12.7</p>
<h4 id="32位设备，运行下列命令"><a href="#32位设备，运行下列命令" class="headerlink" title="32位设备，运行下列命令"></a>32位设备，运行下列命令</h4><ol>
<li><span class="kwd">cd</span> <span class="pun">/</span><span class="pln">tmp</span><br><span class="kwd">wget</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//kernel.ubuntu.com/~kernel-ppa/mainline/v3.12.7-trusty/linux-headers-3.12.7-031207-generic_3.12.7-031207.201401091657_i386.deb <a href="http://kernel.ubuntu.com/~kernel-ppa/mainline/v3.12.7-trusty/linux-headers-3.12.7-031207_3.12.7-031207.201401091657_all.deb" target="_blank" rel="external">http://kernel.ubuntu.com/~kernel-ppa/mainline/v3.12.7-trusty/linux-headers-3.12.7-031207_3.12.7-031207.201401091657_all.deb</a> <a href="http://kernel.ubuntu.com/~kernel-ppa/mainline/v3.12.7-trusty/linux-image-3.12.7-031207-generic_3.12.7-031207.201401091657_i386.deb" target="_blank" rel="external">http://kernel.ubuntu.com/~kernel-ppa/mainline/v3.12.7-trusty/linux-image-3.12.7-031207-generic_3.12.7-031207.201401091657_i386.deb</a></span></li>
</ol>
<h4 id="64位设备，运行下列命令"><a href="#64位设备，运行下列命令" class="headerlink" title="64位设备，运行下列命令"></a>64位设备，运行下列命令</h4><ol>
<li><p><span class="kwd">cd</span> <span class="pun">/</span><span class="pln">tmp</span><br><span class="kwd">wget</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//kernel.ubuntu.com/~kernel-ppa/mainline/v3.12.7-trusty/linux-headers-3.12.7-031207-generic_3.12.7-031207.201401091657_amd64.deb <a href="http://kernel.ubuntu.com/~kernel-ppa/mainline/v3.12.7-trusty/linux-headers-3.12.7-031207_3.12.7-031207.201401091657_all.deb" target="_blank" rel="external">http://kernel.ubuntu.com/~kernel-ppa/mainline/v3.12.7-trusty/linux-headers-3.12.7-031207_3.12.7-031207.201401091657_all.deb</a> <a href="http://kernel.ubuntu.com/~kernel-ppa/mainline/v3.12.7-trusty/linux-image-3.12.7-031207-generic_3.12.7-031207.201401091657_amd64.deb" target="_blank" rel="external">http://kernel.ubuntu.com/~kernel-ppa/mainline/v3.12.7-trusty/linux-image-3.12.7-031207-generic_3.12.7-031207.201401091657_amd64.deb</a></span><br>下载你的系统对应版本后，运行下列命令</p>
</li>
<li><p><span class="kwd">sudo</span><span class="pln"> dpkg </span><span class="pun">-</span><span class="pln">i </span><span class="pun">*.</span><span class="pln">deb</span><br>安装完成后，重启你的设备，如果一切都按照上面描述一样进展顺利，你的系统应该拥有了最新稳定的内核版本。</p>
</li>
</ol>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201403/19/233615dnal0bpykvuy0sab.jpg" alt=""></p>
<p>卸载内核3.12.7版本，使用下列命令</p>
<ol>
<li><span class="kwd">sudo</span> <span class="kwd">apt-get</span><span class="pln"> remove linux</span><span class="pun">-</span><span class="pln">headers</span><span class="pun">-</span><span class="lit">3.12</span><span class="pun">.</span><span class="lit">7</span><span class="pun">-<em></em></span><span class="pln"> linux</span><span class="pun">-</span><span class="pln">image</span><span class="pun">-</span><span class="lit">3.13</span><span class="pun">.</span><span class="lit">7</span><span class="pun">-</span><br>好好享受吧！</li>
</ol>
<p>&nbsp;</p>
<p>Reading package lists… Done W: There is no public key available for the following key IDs: 7638D0442B90D010 W: There is no public key available for the following key IDs: 7638D0442B90D010 W: There is no public key available for the following key IDs: 9D6D8F6BC857C906</p>
<p>apt-get install debian-keyring debian-archive-keyring<br>apt-get update</p>
<div><br><div id="highlighter_374070" class="syntaxhighlighter  shell"><br><table style="height: 45px;" border="0" width="715" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="gutter"></td><br><td class="code">整个世界，清静了 :-D<br><div class="container"></div></td><br></tr><br></tbody><br></table><br></div><br></div>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/记录/">记录</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-e5-9c-a8-e6-90-ac-e7-93-a6-e5-b7-a5-e7-9a-84centos7-e4-b8-8b-e6-90-ad-e5-bb-bastrongswan-e5-ae-9e-e7-8e-b0-e5-9c-a8ios-e4-b8-8a-e6-8c-89-e9-9c-80-e8-bf-9e-e6-8e-a5vpn" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/09/30/e5-9c-a8-e6-90-ac-e7-93-a6-e5-b7-a5-e7-9a-84centos7-e4-b8-8b-e6-90-ad-e5-bb-bastrongswan-e5-ae-9e-e7-8e-b0-e5-9c-a8ios-e4-b8-8a-e6-8c-89-e9-9c-80-e8-bf-9e-e6-8e-a5vpn/" class="article-date">
      <time datetime="2015-09-30T06:59:49.000Z" itemprop="datePublished">2015-09-30</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/09/30/e5-9c-a8-e6-90-ac-e7-93-a6-e5-b7-a5-e7-9a-84centos7-e4-b8-8b-e6-90-ad-e5-bb-bastrongswan-e5-ae-9e-e7-8e-b0-e5-9c-a8ios-e4-b8-8a-e6-8c-89-e9-9c-80-e8-bf-9e-e6-8e-a5vpn/">在搬瓦工的CentOS7下搭建Strongswan实现在iOS上按需连接VPN</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>查到的全是在Debian和Ubuntu下的教程，各种命令语法跟CentOS还有出入，Allen还是各种躲避。。。经历重新安装Debian后又重新装回CentOS的折腾后，终于搞定了。主要还是参考了<a href="http://songchenwen.github.io/tech/2014/10/13/cross-fire-wall-on-ios8/" target="_blank" rel="external">iOS8 不越狱翻墙方案</a>和<a href="https://medium.com/@cattyhouse/ios-ondemand-ipsec-vpn-setup-ebfb82b6f7a1" target="_blank" rel="external">iOS Ondemand IPSec VPN Setup</a>，这两篇都是Debian和Ubuntu，只要稍作改动即可安装到CentOS上，简易教程来&#x1f426;。</p>
<p>首先我们来编译Strongswan，因为直接用yum install 的不能用，不解中&#x1f616; 下载源码和依赖包</p>
<pre><code>wget [http://download.strongswan.org/strongswan-5.2.2.tar.bz2](http://download.strongswan.org/strongswan-5.2.2.tar.bz2)
tar xjvf strongswan-5.2.2.tar.bz2; cd strongswan-5.2.2
yum install make gcc gmp-devel
`&lt;/pre&gt;
搬瓦工是OpenVZ的所以用下面的命令来配置
&lt;pre&gt;`./configure --sysconfdir=/etc --disable-sql --disable-mysql --disable-ldap --enable-dhcp --enable-eap-identity --enable-eap-mschapv2 --enable-md4 --enable-xauth-eap --enable-eap-peap --enable-eap-md5 --enable-openssl --enable-shared --enable-unity --enable-eap-tls   --enable-eap-ttls --enable-eap-tnc --enable-eap-dynamic --enable-addrblock --enable-radattr --enable-nat-transport --enable-kernel-netlink --enable-kernel-libipsec
`&lt;/pre&gt;

## 开始编译

&lt;pre&gt;`make &amp;amp;&amp;amp; sudo make install
`&lt;/pre&gt;
完全没有错误出现✌️

## 生成证书

开始生成证书想要ssl证书的可以看文章里的链接，有列出哦 建立个临时目录来生成证书，然后复制到/etc/ipsec.d/里
&lt;pre&gt;`mkdir ~/ipsec_cert &amp;amp;&amp;amp; cd ~/ipsec_cert
`&lt;/pre&gt;

### 生成服务器证书

用的是[iOS8 不越狱翻墙方案](http://songchenwen.github.io/tech/2014/10/13/cross-fire-wall-on-ios8/)他创建的脚本。SERVER换成泥自己的域名或IP都行
&lt;pre&gt;`wget [https://gist.githubusercontent.com/songchenwen/14c1c663ea65d5d4a28b/raw/cef8d8bafe6168388b105f780c442412e6f8ede7/server_key.sh](https://gist.githubusercontent.com/songchenwen/14c1c663ea65d5d4a28b/raw/cef8d8bafe6168388b105f780c442412e6f8ede7/server_key.sh)
sh server_key.sh SERVER
`&lt;/pre&gt;

### 生成客户端证书

同样是他的脚本，这个脚本还会生成一个p12证书，这个证书需要导入到iOS里，USER换成你自己的用户名 EMAIL换成你自己的email。
&lt;pre&gt;`wget [https://gist.githubusercontent.com/songchenwen/14c1c663ea65d5d4a28b/raw/54843ae2e5e6d1159134cd9a90a08c31ff5a253d/client_key.sh](https://gist.githubusercontent.com/songchenwen/14c1c663ea65d5d4a28b/raw/54843ae2e5e6d1159134cd9a90a08c31ff5a253d/client_key.sh)
sh client_key.sh USER EMAIL
`&lt;/pre&gt;
执行完后把.p12证书和cacerts/strongswanCert.pem 下载到本地来备用

我是在～目录里生成的证书，所以在本地端命令如下：
&lt;pre&gt;`scp -P ssh端口 root@服务器ip:~/ipsec_cert/janner.p12 ~/
scp -P ssh端口 root@服务器ip:~/ipsec_cert/cacerts strongswanCert.pem ~/
`&lt;/pre&gt;

## 配置Strongswan

### 编辑 /etc/ipsec.conf

&lt;pre&gt;`sudo vi /etc/ipsec.conf
`&lt;/pre&gt;
&lt;pre&gt;`config setup
    # strictcrlpolicy=yes
    #  uniqueids = replace
    # charondebug=&quot;cfg 2, dmn 2, ike 2, net 0&quot; #要看Log时，取消注释本行

conn %default
    keyexchange=ikev1
    dpdaction=hold
    dpddelay=600s
    dpdtimeout=5s
    lifetime=24h
    ikelifetime=240h
    rekey=no
    left=emptyzone.github.io #这里换成你登录 VPN 用的域名或 IP，与生成证书时相同 
    leftsubnet=0.0.0.0/0
    leftcert=vpnHostCert.pem
    leftsendcert=always
    right=%any
    rightdns=8.8.8.8
    rightsourceip=10.0.0.0/8

conn CiscoIPSec
    rightauth=pubkey
    rightauth2=xauth
    auto=add
`&lt;/pre&gt;

### 编辑/etc/ipsec.secrets

&lt;pre&gt;`sudo vi /etc/ipsec.secrets
`&lt;/pre&gt;
&lt;pre&gt;`#验证用户所需的信息
#用户名 : EAP &quot;密码&quot;
: RSA vpnHostKey.pem
你的用户名 : EAP &quot;你的密码&quot;  
`&lt;/pre&gt;

## 配置防火墙

&gt; 如果你看过我上一篇blog，防火墙就简单配置下，用firewalld很简单 主要就是开放4500、500端口和esp协议

### 编辑/usr/lib/firewalld/services/ipsec.xml如下：

&lt;pre&gt;`&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&amp;gt;
&amp;lt;service&amp;gt;
  &amp;lt;short&amp;gt;IPsec&amp;lt;/short&amp;gt;
  &amp;lt;description&amp;gt;Internet Protocol Security (IPsec) incorporates security for network transmissions directly into the Internet Protocol (IP). IPsec provides methods for both encrypting data and authentication for the host or network it sends to. If you plan to use a vpnc server or FreeS/WAN, do not disable this option.&amp;lt;/description&amp;gt;
  &amp;lt;port protocol=&quot;ah&quot; port=&quot;&quot;/&amp;gt;
  &amp;lt;port protocol=&quot;esp&quot; port=&quot;&quot;/&amp;gt;
  &amp;lt;port protocol=&quot;udp&quot; port=&quot;500&quot;/&amp;gt;
  &amp;lt;port protocol=&quot;udp&quot; port=&quot;4500&quot;/&amp;gt;
&amp;lt;/service&amp;gt;
`&lt;/pre&gt;
然后依次输入如下命令就OK了✌️
&lt;pre&gt;`
firewall-cmd --permanent --add-service=ipsec
firewall-cmd --permanent --add-masquerade
firewall-cmd --reload
</code></pre><p>其他的就是配置分流路由器和开机启动啥的，我都没怎么配置，到此服务器端配置结束&#x1f604;</p>
<p>你可以把下载的两个证书用email发送到你的iOS上，安装后建立个VPN连接，选IPsec，使用证书，选择你的用户名的证书即可，登录下试试吧。成功后就可以按照我上文所引用的两篇文章来使用Apple Configurator来配置你的描述文件，通用用email发送到iOS上安装即可，断线切换网络都会自动连接，给力吧，可以暂时抛弃Anyconnect了吧，哇咔咔，高级配置如只有特定域名才会连VPN的也能设置，自己可以琢磨了&#x1f604;</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/记录/">记录</a>
    </div>


      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/7/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016 Any_冰
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>